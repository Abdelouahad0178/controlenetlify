<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Administration Sécurisée - Anapharmo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2b;
      --line: #203054;
      --brand: #1a2a4a;
      --brand2: #2b406b;
      --ok: #b7ffc3;
      --bad: #ffb4b4;
      --warning: #ffd93d;
      --text: #eaeef7;
      --muted: #8892b0;
      --header-height: 70px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Header responsive */
    header {
      padding: 12px 16px;
      background: #15223a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--line);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
      min-height: var(--header-height);
      flex-wrap: wrap;
      gap: 12px;
    }

    h1 {
      margin: 0;
      font-size: clamp(18px, 4vw, 24px);
      font-weight: 600;
    }

    h2 {
      margin-top: 0;
      color: var(--text);
      font-size: clamp(16px, 3vw, 18px);
      font-weight: 600;
    }

    /* Auth section responsive */
    #auth {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .login-form {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #userInfo {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    #userAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--brand);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }

    /* Cards responsives */
    .card {
      background: var(--panel);
      border: 1px solid #223355;
      border-radius: 12px;
      padding: 16px;
      margin: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    /* Inputs et boutons responsives */
    input, button, select {
      border-radius: 8px;
      border: 1px solid var(--brand2);
      background: #0e1830;
      color: #fff;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.2s ease;
      min-height: 44px; /* Taille tactile minimum */
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--ok);
      box-shadow: 0 0 0 3px rgba(183, 255, 195, 0.1);
    }

    button {
      background: var(--brand);
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: 1px solid var(--brand2);
    }

    button:hover:not(:disabled) {
      filter: brightness(1.15);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    button.danger {
      background: #dc2626;
      border-color: #dc2626;
    }

    button.success {
      background: #059669;
      border-color: #059669;
    }

    button.warning {
      background: #f59e0b;
      border-color: #f59e0b;
    }

    button.payment {
      background: #ff6600;
      border-color: #ff6600;
    }

    .hidden {
      display: none !important;
    }

    /* Toolbar responsive */
    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .search-bar {
      flex: 1;
      min-width: 200px;
    }

    /* Tableaux responsives */
    #usersTableContainer {
      overflow-x: auto;
      margin: 16px 0;
      border-radius: 8px;
      border: 1px solid var(--line);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Largeur minimum pour éviter l'écrasement */
    }

    th, td {
      border-bottom: 1px solid var(--line);
      padding: 12px;
      text-align: left;
      font-size: 14px;
      white-space: nowrap;
    }

    th {
      background: rgba(26, 42, 74, 0.7);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background: rgba(32, 48, 84, 0.3);
    }

    .status-active {
      color: var(--ok);
      font-weight: 500;
    }

    .status-disabled {
      color: var(--bad);
      font-weight: 500;
    }

    .payment-warning-badge {
      display: inline-flex;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid #f59e0b;
      font-size: 10px;
      color: var(--warning);
      font-weight: 700;
      margin-left: 6px;
    }

    /* Actions dans le tableau */
    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .actions button {
      padding: 6px 10px;
      font-size: 12px;
      min-height: 32px;
      white-space: nowrap;
    }

    /* Alertes responsives */
    #alertContainer {
      position: fixed;
      top: calc(var(--header-height) + 10px);
      right: 16px;
      z-index: 1000;
      max-width: calc(100vw - 32px);
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 8px 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
    }

    .alert-success {
      background: rgba(5, 150, 105, 0.2);
      border: 1px solid #059669;
      color: var(--ok);
    }

    .alert-error {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid #dc2626;
      color: var(--bad);
    }

    .alert-warning {
      background: rgba(255, 217, 61, 0.2);
      border: 1px solid #ffd93d;
      color: var(--warning);
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
      color: #3b82f6;
    }

    /* RESPONSIVE BREAKPOINTS */

    /* TABLETTES (768px - 1023px) */
    @media (max-width: 1023px) and (min-width: 768px) {
      .card {
        margin: 12px;
        padding: 20px;
      }

      .toolbar {
        gap: 10px;
      }

      .search-bar {
        min-width: 150px;
      }

      table {
        min-width: 700px;
      }

      th, td {
        padding: 10px 8px;
        font-size: 13px;
      }

      .actions button {
        padding: 4px 8px;
        font-size: 11px;
      }
    }

    /* MOBILES (moins de 768px) */
    @media (max-width: 767px) {
      header {
        padding: 8px 12px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        position: relative; /* Évite les problèmes de sticky */
        --header-height: auto;
      }

      h1 {
        text-align: center;
        font-size: 18px;
      }

      #auth {
        justify-content: center;
      }

      .login-form {
        width: 100%;
        justify-content: center;
      }

      .login-form input {
        flex: 1;
        min-width: 120px;
        font-size: 16px; /* Évite le zoom sur iOS */
      }

      #userInfo {
        justify-content: center;
        width: 100%;
      }

      #userEmail {
        font-size: 14px;
        text-overflow: ellipsis;
        overflow: hidden;
        max-width: 150px;
      }

      .card {
        margin: 8px;
        padding: 12px;
        border-radius: 10px;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .search-bar {
        width: 100%;
        min-width: auto;
        font-size: 16px;
      }

      select {
        width: 100%;
        font-size: 16px;
      }

      button {
        width: 100%;
        padding: 14px 16px;
        font-size: 16px;
      }

      /* Tableau en scroll horizontal sur mobile */
      #usersTableContainer {
        margin: 12px -12px; /* Étend jusqu'aux bords de la card */
        border-left: none;
        border-right: none;
        border-radius: 0;
      }

      table {
        min-width: 600px;
      }

      th, td {
        padding: 8px 6px;
        font-size: 12px;
      }

      .actions {
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
      }

      .actions button {
        width: 100%;
        padding: 6px 8px;
        font-size: 10px;
        min-height: 28px;
      }

      .payment-warning-badge {
        display: block;
        margin: 2px 0;
        text-align: center;
      }

      /* Alertes en pleine largeur sur mobile */
      #alertContainer {
        position: fixed;
        top: 10px;
        left: 8px;
        right: 8px;
        max-width: none;
      }

      .alert {
        padding: 10px 12px;
        font-size: 14px;
      }
    }

    /* TRÈS PETITS ÉCRANS (moins de 480px) */
    @media (max-width: 479px) {
      .card {
        margin: 4px;
        padding: 8px;
      }

      h2 {
        font-size: 16px;
      }

      .login-form {
        flex-direction: column;
        gap: 8px;
      }

      .login-form input, .login-form button {
        width: 100%;
      }

      table {
        min-width: 500px;
      }

      th, td {
        padding: 6px 4px;
        font-size: 11px;
      }

      .actions button {
        font-size: 9px;
        padding: 4px 6px;
      }
    }

    /* GRANDS ÉCRANS (plus de 1200px) */
    @media (min-width: 1200px) {
      .card {
        margin: 24px auto;
        max-width: 1400px;
        padding: 24px;
      }

      header {
        padding: 16px 24px;
      }

      .toolbar {
        gap: 16px;
      }

      th, td {
        padding: 14px 16px;
        font-size: 15px;
      }

      .actions button {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    /* Améliorations pour l'accessibilité */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus visible pour la navigation au clavier */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--ok);
      outline-offset: 2px;
    }

    /* Focus pour les éléments du tableau */
    #usersTableContainer:focus {
      outline: 2px solid var(--ok);
      outline-offset: 2px;
    }

    /* Amélioration du contraste pour les utilisateurs à mobilité réduite */
    @media (prefers-contrast: high) {
      :root {
        --text: #ffffff;
        --muted: #cccccc;
        --bg: #000000;
        --panel: #1a1a1a;
      }
    }

    /* Support pour les lecteurs d'écran */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Scroll bars personnalisées */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--brand2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--brand);
    }
  </style>
</head>
<body>
  <header>
    <h1>🔐 Administration Anapharmo</h1>
    <div id="auth">
      <form id="loginForm" class="login-form" role="form" aria-label="Formulaire de connexion administrateur">
        <input 
          id="email" 
          type="email" 
          placeholder="admin@email.com" 
          autocomplete="email" 
          aria-label="Adresse email administrateur"
          required 
        />
        <input 
          id="password" 
          type="password" 
          placeholder="••••••••" 
          autocomplete="current-password"
          aria-label="Mot de passe administrateur"
          required 
        />
        <button type="submit" id="loginBtn" aria-describedby="login-status">Connexion</button>
      </form>
      <div id="userInfo" class="hidden">
        <div id="userAvatar">A</div>
        <span id="userEmail">user@email.com</span>
        <button id="logoutBtn" class="danger">Déconnexion</button>
      </div>
    </div>
  </header>

  <div id="alertContainer" aria-live="polite" aria-label="Zone de notifications"></div>

  <div class="card">
    <h2>👥 Gestion des utilisateurs</h2>

    <div id="adminInterface" class="hidden">
      <div class="toolbar" role="toolbar" aria-label="Outils de filtrage des utilisateurs">
        <input 
          id="searchUsers" 
          class="search-bar" 
          placeholder="🔍 Rechercher..." 
          autocomplete="off"
          aria-label="Rechercher des utilisateurs par nom ou email"
          type="search"
        />
        <select id="roleFilter" aria-label="Filtrer par rôle">
          <option value="">Tous les rôles</option>
          <option value="admin">Admin</option>
          <option value="vendeuse">Vendeuse</option>
          <option value="moderator">Modérateur</option>
          <option value="user">Utilisateur</option>
        </select>
        <select id="statusFilter" aria-label="Filtrer par statut">
          <option value="">Tous les statuts</option>
          <option value="active">Actifs</option>
          <option value="disabled">Désactivés</option>
          <option value="warned">Avertis paiement</option>
        </select>
        <button id="refreshUsers" aria-label="Actualiser la liste des utilisateurs">🔄 Actualiser</button>
      </div>

      <div id="usersTableContainer" role="region" aria-label="Tableau des utilisateurs" tabindex="0">
        <table role="table" aria-label="Liste des utilisateurs avec leurs informations et actions">
          <thead>
            <tr role="row">
              <th role="columnheader" scope="col">👤 Utilisateur</th>
              <th role="columnheader" scope="col">📧 Email</th>
              <th role="columnheader" scope="col">🏷️ Rôle</th>
              <th role="columnheader" scope="col">📊 Statut</th>
              <th role="columnheader" scope="col">📅 Créé le</th>
              <th role="columnheader" scope="col">🔧 Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>

    <div id="loginPrompt" class="alert alert-info" role="status" aria-live="polite">
      🔒 <strong>Connexion requise</strong> — Connectez-vous avec un compte administrateur.
    </div>
  </div>

  <!-- Status pour les lecteurs d'écran -->
  <div id="login-status" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, limit, serverTimestamp, addDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHQSPXwED7W-FQMMs1D-OZcjW-5AP8A-w",
      authDomain: "anapharmo.firebaseapp.com",
      projectId: "anapharmo",
      storageBucket: "anapharmo.firebasestorage.app",
      messagingSenderId: "1097322827362",
      appId: "1:1097322827362:web:fd19a67d9af135dcbf4b3b",
      measurementId: "G-JX6HCRX075"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "echchaaba0178@gmail.com";

    const el = {
      loginForm: document.getElementById('loginForm'),
      loginBtn: document.getElementById('loginBtn'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      userInfo: document.getElementById('userInfo'),
      userEmail: document.getElementById('userEmail'),
      userAvatar: document.getElementById('userAvatar'),
      logoutBtn: document.getElementById('logoutBtn'),
      adminInterface: document.getElementById('adminInterface'),
      loginPrompt: document.getElementById('loginPrompt'),
      usersTable: document.getElementById('usersTable'),
      searchUsers: document.getElementById('searchUsers'),
      roleFilter: document.getElementById('roleFilter'),
      statusFilter: document.getElementById('statusFilter'),
      alertContainer: document.getElementById('alertContainer')
    };

    let currentUser = null;
    let isAdmin = false;
    let allUsers = [];
    let unsubUsers = null;
    let unsubLogs = null;

    const showAlert = (type, message, duration = 4000) => {
      const a = document.createElement('div');
      a.className = `alert alert-${type}`;
      a.setAttribute('role', type === 'error' ? 'alert' : 'status');
      a.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
      a.setAttribute('aria-atomic', 'true');
      a.innerHTML = `<strong>${type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️'}</strong> ${message}`;
      el.alertContainer.appendChild(a);
      
      // Auto-remove après la durée spécifiée
      setTimeout(() => {
        a.style.opacity = '0';
        setTimeout(() => {
          if (a.parentNode) a.remove();
        }, 300);
      }, duration - 300);
    };

    const formatDate = (ts) => {
      if (!ts) return '-';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString('fr-FR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    };

    const formatRole = (role) => {
      const map = { 
        admin: 'Admin', 
        vendeuse: 'Vendeuse', 
        moderator: 'Modérateur', 
        user: 'Utilisateur' 
      };
      return map[role] || 'Utilisateur';
    };

    const updateUI = (user) => {
      if (user) {
        currentUser = user;
        isAdmin = user.email === ADMIN_EMAIL;
        el.loginForm.classList.add('hidden');
        el.userInfo.classList.remove('hidden');
        el.userEmail.textContent = user.email;
        el.userAvatar.textContent = user.email.substring(0, 2).toUpperCase();

        if (isAdmin) {
          el.adminInterface.classList.remove('hidden');
          el.loginPrompt.classList.add('hidden');
          listenUsers();
        } else {
          el.adminInterface.classList.add('hidden');
          el.loginPrompt.classList.remove('hidden');
          if (unsubUsers) unsubUsers();
        }
      } else {
        currentUser = null; 
        isAdmin = false;
        el.loginForm.classList.remove('hidden');
        el.userInfo.classList.add('hidden');
        el.adminInterface.classList.add('hidden');
        el.loginPrompt.classList.remove('hidden');
        if (unsubUsers) unsubUsers();
        allUsers = [];
        el.usersTable.innerHTML = '';
      }
    };

    const renderUsers = () => {
      const term = (el.searchUsers.value || '').toLowerCase();
      const roleF = el.roleFilter.value;
      const statusF = el.statusFilter.value;

      const filtered = allUsers.filter(u => {
        const search = (u.email || '').toLowerCase().includes(term) || 
                      (u.displayName || '').toLowerCase().includes(term);
        const roleMatch = !roleF || u.role === roleF;
        const statusMatch =
          !statusF ||
          (statusF === 'active' && u.status === 'active') ||
          (statusF === 'disabled' && (u.status === 'disabled' || u.locked === true)) ||
          (statusF === 'warned' && u.paymentWarning && u.paymentWarning.status === 'active');
        return search && roleMatch && statusMatch;
      });

      if (filtered.length === 0) {
        el.usersTable.innerHTML = `
          <tr role="row">
            <td colspan="6" style="text-align:center;padding:32px;color:var(--muted);font-style:italic;" role="cell">
              Aucun utilisateur trouvé
            </td>
          </tr>
        `;
        return;
      }

      el.usersTable.innerHTML = filtered.map((u, index) => {
        const isLocked = (u.locked === true) || (u.status === 'disabled');
        const isWarned = !!(u.paymentWarning && u.paymentWarning.status === 'active');
        const warnedBadge = isWarned ? `<span class="payment-warning-badge" aria-label="Utilisateur averti pour paiement">Averti</span>` : '';
        
        return `
          <tr role="row" aria-rowindex="${index + 2}">
            <td role="cell">
              <div style="display:flex;align-items:center;gap:8px;">
                <strong>${u.displayName || 'Sans nom'}</strong>
                ${warnedBadge}
              </div>
            </td>
            <td role="cell" title="${u.email || '—'}">${u.email || '—'}</td>
            <td role="cell">${formatRole(u.role)}</td>
            <td role="cell">
              <span class="${u.status === 'active' ? 'status-active' : 'status-disabled'}" 
                    aria-label="Statut: ${u.status === 'active' ? 'Compte actif' : 'Compte désactivé'}">
                ${u.status === 'active' ? '✅ Actif' : '🔒 Désactivé'}
              </span>
            </td>
            <td role="cell">${formatDate(u.createdAt)}</td>
            <td role="cell" class="actions">
              <button class="${isLocked ? 'success' : 'danger'}" 
                      onclick="window.toggleLock('${u.uid}')"
                      aria-label="${isLocked ? 'Déverrouiller le compte de ' + (u.email || 'cet utilisateur') : 'Verrouiller le compte de ' + (u.email || 'cet utilisateur')}"
                      title="${isLocked ? 'Déverrouiller ce compte' : 'Verrouiller ce compte'}">
                ${isLocked ? '🔓 Déverrouiller' : '🔒 Verrouiller'}
              </button>
              <button class="${isWarned ? 'payment' : 'warning'}" 
                      onclick="window.togglePaymentWarning('${u.uid}')"
                      aria-label="${isWarned ? 'Désactiver l\'avertissement de paiement pour ' + (u.email || 'cet utilisateur') : 'Envoyer un avertissement de paiement à ' + (u.email || 'cet utilisateur')}"
                      title="${isWarned ? 'Désactiver l\'avertissement' : 'Envoyer un avertissement'}">
                ${isWarned ? '💸 Averti ON' : '💰 Averti OFF'}
              </button>
            </td>
          </tr>
        `;
      }).join('');
    };

    const listenUsers = () => {
      if (unsubUsers) unsubUsers();
      const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
      unsubUsers = onSnapshot(q, snap => {
        allUsers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
        renderUsers();
      }, err => {
        console.error('Erreur Firebase:', err);
        showAlert('error', "Erreur de chargement des utilisateurs");
      });
    };

    // --------- TOGGLES ---------

    // Verrouiller / Déverrouiller
    window.toggleLock = async (uid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');

      const isLocked = (u.locked === true) || (u.status === 'disabled');

      try {
        if (!isLocked) {
          // LOCK
          const title = prompt("Titre du popup (utilisateur)", "🔒 Compte verrouillé") || "🔒 Compte verrouillé";
          const message = prompt("Message du popup", "Votre compte a été verrouillé par l'administrateur. Contactez le support.") || "Votre compte a été verrouillé par l'administrateur. Contactez le support.";
          const details = prompt("Détails (facultatif)", "Raison: sécurité / usage.") || "Raison: sécurité / usage.";
          const hours = parseInt(prompt("Durée du popup (heures)", "24"), 10) || 24;
          const expiryISO = new Date(Date.now() + hours * 3600 * 1000).toISOString();

          if (!confirm(`Confirmer VERROUILLAGE de ${u.email} ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            status: 'disabled',
            locked: true,
            lockedAt: serverTimestamp(),
            lockedBy: currentUser.email,
            adminPopup: {
              status: 'active',
              type: 'lockNotice',
              title, message, details,
              issuedAt: serverTimestamp(),
              expiryDate: expiryISO,
              issuedBy: currentUser.email
            }
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_LOCKED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Compte verrouillé + popup admin (${hours}h).`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Utilisateur ${u.email} verrouillé avec succès.`);
        } else {
          // UNLOCK
          const hours = parseInt(prompt("Durée du popup d'info (heures)", "12"), 10) || 12;
          const expiryISO = new Date(Date.now() + hours * 3600 * 1000).toISOString();

          if (!confirm(`Déverrouiller ${u.email} ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            status: 'active',
            locked: false,
            lockedAt: deleteField(),
            lockedBy: deleteField(),
            adminPopup: {
              status: 'active',
              type: 'unlockNotice',
              title: '✅ Compte réactivé',
              message: 'Votre accès a été rétabli.',
              details: `Réactivation par ${currentUser.email}.`,
              issuedAt: serverTimestamp(),
              expiryDate: expiryISO,
              issuedBy: currentUser.email
            }
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_UNLOCKED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Compte déverrouillé + popup info (${hours}h).`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Utilisateur ${u.email} déverrouillé avec succès.`);
        }
      } catch (e) {
        console.error('Erreur toggle lock:', e);
        showAlert('error', `Erreur: ${e.message}`);
      }
    };

    // Avertissement paiement ON/OFF
    window.togglePaymentWarning = async (uid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');

      const isWarned = !!(u.paymentWarning && u.paymentWarning.status === 'active');

      try {
        if (isWarned) {
          if (!confirm(`Désactiver l'avertissement paiement pour ${u.email} ?`)) return;
          
          await updateDoc(doc(db, 'users', uid), { 
            paymentWarning: deleteField() 
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'PAYMENT_WARNING_DISABLED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Avertissement de paiement désactivé.`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Avertissement désactivé pour ${u.email}.`);
        } else {
          const hours = parseInt(prompt("Durée (heures)", "24"), 10) || 24;
          const expiryISO = new Date(Date.now() + hours * 3600 * 1000).toISOString();
          
          if (!confirm(`Envoyer AVERTISSEMENT de paiement à ${u.email} (${hours}h) ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            paymentWarning: {
              status: 'active',
              issuedAt: serverTimestamp(),
              expiryDate: expiryISO,
              issuedBy: currentUser.email,
              reason: 'payment'
            }
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'PAYMENT_WARNING_SENT',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Avertissement paiement envoyé (${hours}h).`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Avertissement envoyé à ${u.email}.`);
        }
      } catch (e) {
        console.error('Erreur payment warning:', e);
        showAlert('error', `Erreur: ${e.message}`);
      }
    };

    // ---- Initialisation UI/Auth ----
    el.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      el.loginBtn.disabled = true;
      el.loginBtn.textContent = 'Connexion...';
      
      // Annonce pour les lecteurs d'écran
      const statusEl = document.getElementById('login-status');
      statusEl.textContent = 'Tentative de connexion en cours...';
      
      try {
        await signInWithEmailAndPassword(auth, el.email.value, el.password.value);
        showAlert('success', 'Connexion réussie !');
        statusEl.textContent = 'Connexion réussie';
      } catch (err) {
        console.error('Erreur connexion:', err);
        showAlert('error', `Erreur de connexion: ${err.message}`);
        statusEl.textContent = `Erreur de connexion: ${err.message}`;
      } finally {
        el.loginBtn.disabled = false;
        el.loginBtn.textContent = 'Connexion';
        // Nettoie le message après 3 secondes
        setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);
      }
    });

    el.logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showAlert('info', 'Déconnexion réussie');
      } catch (err) {
        showAlert('error', `Erreur déconnexion: ${err.message}`);
      }
    });

    // Event listeners pour les filtres
    el.searchUsers.addEventListener('input', renderUsers);
    el.roleFilter.addEventListener('change', renderUsers);
    el.statusFilter.addEventListener('change', renderUsers);
    
    // Bouton actualiser
    document.getElementById('refreshUsers').addEventListener('click', () => {
      if (isAdmin) {
        listenUsers();
        showAlert('info', 'Liste des utilisateurs actualisée');
      }
    });

    // Observer les changements d'auth
    onAuthStateChanged(auth, (user) => {
      updateUI(user);
    });

    // Gestion des erreurs globales
    window.addEventListener('error', (e) => {
      console.error('Erreur globale:', e.error);
      showAlert('error', 'Une erreur inattendue s\'est produite');
    });

    // Log de démarrage
    console.log('🔐 Administration Anapharmo - Version Responsive avec accessibilité améliorée chargée');
    console.log('✅ Attributs autocomplete ajoutés');
    console.log('✅ Support des lecteurs d\'écran amélioré');
    console.log('✅ Navigation au clavier optimisée');
  </script>
</body>
</html>