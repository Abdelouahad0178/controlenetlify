<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Administration Sécurisée - Anapharmo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2b;--line:#203054;--brand:#1a2a4a;--brand2:#2b406b;
      --ok:#b7ffc3;--bad:#ffb4b4;--warning:#ffd93d;--text:#eaeef7;--muted:#8892b0;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial;line-height:1.5}
    header{padding:16px 24px;background:#15223a;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--line)}
    h1{margin:0;font-size:24px;font-weight:600}
    .card{background:var(--panel);border:1px solid #223355;border-radius:14px;padding:20px;margin:16px;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
    .card h2{margin-top:0;color:var(--text);font-size:18px}
    input,button,select{border-radius:8px;border:1px solid var(--brand2);background:#0e1830;color:#fff;padding:10px 16px;font-size:14px}
    button{background:var(--brand);cursor:pointer;transition:all .2s;font-weight:500}
    button:hover{filter:brightness(1.15);transform:translateY(-1px)}
    button:disabled{opacity:.6;cursor:not-allowed}
    button.danger{background:#dc2626;border-color:#dc2626}
    button.success{background:#059669;border-color:#059669}
    button.warning{background:#f59e0b;border-color:#f59e0b}
    button.payment{background:#ff6600;border-color:#ff6600}
    .hidden{display:none !important}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;font-size:14px}
    th{background:rgba(26,42,74,.5);font-weight:600}
    tr:hover{background:rgba(32,48,84,.3)}
    .status-active{color:var(--ok);font-weight:500}
    .status-disabled{color:var(--bad);font-weight:500}
    .payment-warning-badge{display:inline-flex;gap:4px;padding:2px 6px;border-radius:10px;background:rgba(245,158,11,.2);border:1px solid #f59e0b;font-size:10px;color:var(--warning);font-weight:700}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .alert{padding:12px 16px;border-radius:8px;margin:16px}
    .alert-success{background:rgba(5,150,105,.2);border:1px solid #059669;color:var(--ok)}
    .alert-error{background:rgba(220,38,38,.2);border:1px solid #dc2626;color:var(--bad)}
    .alert-warning{background:rgba(255,217,61,.2);border:1px solid #ffd93d;color:var(--warning)}
    .alert-info{background:rgba(59,130,246,.2);border:1px solid #3b82f6;color:#3b82f6}
  </style>
</head>
<body>
  <header>
    <h1>🔐 Administration Anapharmo</h1>
    <div id="auth">
      <form id="loginForm" class="login-form">
        <input id="email" type="email" placeholder="admin@email.com" required />
        <input id="password" type="password" placeholder="••••••••" required />
        <button type="submit" id="loginBtn">Connexion</button>
      </form>
      <div id="userInfo" class="hidden" style="display:flex;align-items:center;gap:10px;">
        <div id="userAvatar" style="width:32px;height:32px;border-radius:50%;background:#1a2a4a;display:flex;align-items:center;justify-content:center;font-weight:700;">A</div>
        <span id="userEmail">user@email.com</span>
        <button id="logoutBtn" class="danger">Déconnexion</button>
      </div>
    </div>
  </header>

  <div id="alertContainer"></div>

  <div class="card">
    <h2>👥 Gestion des utilisateurs</h2>

    <div id="adminInterface" class="hidden">
      <div class="toolbar">
        <input id="searchUsers" class="search-bar" placeholder="🔍 Rechercher..." />
        <select id="roleFilter">
          <option value="">Tous les rôles</option>
          <option value="admin">Admin</option>
          <option value="vendeuse">Vendeuse</option>
          <option value="moderator">Modérateur</option>
          <option value="user">Utilisateur</option>
        </select>
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="active">Actifs</option>
          <option value="disabled">Désactivés</option>
          <option value="warned">Avertis paiement</option>
        </select>
        <button id="refreshUsers">🔄 Actualiser</button>
      </div>

      <div id="usersTableContainer">
        <table>
          <thead>
            <tr>
              <th>👤 Utilisateur</th>
              <th>📧 Email</th>
              <th>🏷️ Rôle</th>
              <th>📊 Statut</th>
              <th>📅 Créé le</th>
              <th>🔧 Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>

    <div id="loginPrompt" class="alert alert-info">
      🔒 <strong>Connexion requise</strong> — Connectez-vous avec un compte administrateur.
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, limit, serverTimestamp, addDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHQSPXwED7W-FQMMs1D-OZcjW-5AP8A-w",
      authDomain: "anapharmo.firebaseapp.com",
      projectId: "anapharmo",
      storageBucket: "anapharmo.firebasestorage.app",
      messagingSenderId: "1097322827362",
      appId: "1:1097322827362:web:fd19a67d9af135dcbf4b3b",
      measurementId: "G-JX6HCRX075"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "echchaaba0178@gmail.com";

    const el = {
      loginForm: document.getElementById('loginForm'),
      loginBtn: document.getElementById('loginBtn'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      userInfo: document.getElementById('userInfo'),
      userEmail: document.getElementById('userEmail'),
      userAvatar: document.getElementById('userAvatar'),
      logoutBtn: document.getElementById('logoutBtn'),
      adminInterface: document.getElementById('adminInterface'),
      loginPrompt: document.getElementById('loginPrompt'),
      usersTable: document.getElementById('usersTable'),
      searchUsers: document.getElementById('searchUsers'),
      roleFilter: document.getElementById('roleFilter'),
      statusFilter: document.getElementById('statusFilter'),
      alertContainer: document.getElementById('alertContainer')
    };

    let currentUser = null;
    let isAdmin = false;
    let allUsers = [];
    let unsubUsers = null;
    let unsubLogs = null;

    const showAlert = (type, message, duration = 4000) => {
      const a = document.createElement('div');
      a.className = `alert alert-${type}`;
      a.innerHTML = `<strong>${type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️'}</strong> ${message}`;
      el.alertContainer.appendChild(a);
      setTimeout(() => a.style.opacity = '0', duration - 500);
      setTimeout(() => a.remove(), duration);
    };
    const formatDate = (ts) => {
      if (!ts) return '-';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    };
    const formatRole = (role) => {
      const map = { admin:'Admin', vendeuse:'Vendeuse', moderator:'Modérateur', user:'Utilisateur' };
      return map[role] || 'Utilisateur';
    };

    const updateUI = (user) => {
      if (user) {
        currentUser = user;
        isAdmin = user.email === ADMIN_EMAIL;
        el.loginForm.classList.add('hidden');
        el.userInfo.classList.remove('hidden');
        el.userEmail.textContent = user.email;
        el.userAvatar.textContent = user.email.substring(0,2).toUpperCase();

        if (isAdmin) {
          el.adminInterface.classList.remove('hidden');
          el.loginPrompt.classList.add('hidden');
          listenUsers();
        } else {
          el.adminInterface.classList.add('hidden');
          el.loginPrompt.classList.remove('hidden');
          if (unsubUsers) unsubUsers();
        }
      } else {
        currentUser = null; isAdmin = false;
        el.loginForm.classList.remove('hidden');
        el.userInfo.classList.add('hidden');
        el.adminInterface.classList.add('hidden');
        el.loginPrompt.classList.remove('hidden');
        if (unsubUsers) unsubUsers();
        allUsers = [];
        el.usersTable.innerHTML = '';
      }
    };

    const renderUsers = () => {
      const term = (el.searchUsers.value || '').toLowerCase();
      const roleF = el.roleFilter.value;
      const statusF = el.statusFilter.value;

      const filtered = allUsers.filter(u => {
        const search = (u.email || '').toLowerCase().includes(term) || (u.displayName || '').toLowerCase().includes(term);
        const roleMatch = !roleF || u.role === roleF;
        const statusMatch =
          !statusF ||
          (statusF === 'active' && u.status === 'active') ||
          (statusF === 'disabled' && (u.status === 'disabled' || u.locked === true)) ||
          (statusF === 'warned' && u.paymentWarning && u.paymentWarning.status === 'active');
        return search && roleMatch && statusMatch;
      });

      if (filtered.length === 0) {
        el.usersTable.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:26px;color:#8892b0">Aucun utilisateur</td></tr>`;
        return;
      }

      el.usersTable.innerHTML = filtered.map(u => {
        const isLocked = (u.locked === true) || (u.status === 'disabled');
        const isWarned = !!(u.paymentWarning && u.paymentWarning.status === 'active');
        const warnedBadge = isWarned ? `<span class="payment-warning-badge">Averti</span>` : '';
        return `
          <tr>
            <td>${u.displayName || '—'} ${warnedBadge}</td>
            <td>${u.email || '—'}</td>
            <td>${formatRole(u.role)}</td>
            <td class="${u.status === 'active' ? 'status-active' : 'status-disabled'}">${u.status || '—'}</td>
            <td>${formatDate(u.createdAt)}</td>
            <td class="actions">
              <button class="${isLocked ? 'success' : 'danger'}" onclick="window.toggleLock('${u.uid}')">
                ${isLocked ? '🔓 Déverrouiller' : '🔒 Verrouiller'}
              </button>
              <button class="${isWarned ? 'payment' : 'warning'}" onclick="window.togglePaymentWarning('${u.uid}')">
                ${isWarned ? '💸 Averti ON' : '💰 Averti OFF'}
              </button>
            </td>
          </tr>
        `;
      }).join('');
    };

    const listenUsers = () => {
      if (unsubUsers) unsubUsers();
      const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
      unsubUsers = onSnapshot(q, snap => {
        allUsers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
        renderUsers();
      }, err => {
        console.error(err);
        showAlert('error', "Erreur de chargement des utilisateurs");
      });
    };

    // --------- TOGGLES ---------

    // Verrouiller / Déverrouiller (adminPopup distinct du paymentWarning)
    window.toggleLock = async (uid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');

      const isLocked = (u.locked === true) || (u.status === 'disabled');

      try {
        if (!isLocked) {
          // LOCK
          const title = prompt("Titre du popup (utilisateur)", "🔒 Compte verrouillé") || "🔒 Compte verrouillé";
          const message = prompt("Message du popup", "Votre compte a été verrouillé par l’administrateur. Contactez le support.") || "Votre compte a été verrouillé par l’administrateur. Contactez le support.";
          const details = prompt("Détails (facultatif)", "Raison: sécurité / usage.") || "Raison: sécurité / usage.";
          const hours = parseInt(prompt("Durée du popup (heures)", "24"), 10) || 24;
          const expiryISO = new Date(Date.now() + hours*3600*1000).toISOString();

          if (!confirm(`Confirmer VERROUILLAGE de ${u.email} ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            status: 'disabled',
            locked: true,
            lockedAt: serverTimestamp(),
            lockedBy: currentUser.email,
            adminPopup: {
              status: 'active',
              type: 'lockNotice',
              title, message, details,
              issuedAt: serverTimestamp(),
              expiryDate: expiryISO,
              issuedBy: currentUser.email
            }
            // on NE touche PAS à paymentWarning ici
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_LOCKED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Compte verrouillé + popup admin (${hours}h).`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Utilisateur ${u.email} verrouillé (déconnexion côté React).`);
        } else {
          // UNLOCK
          const hours = parseInt(prompt("Durée du popup d'info (heures)", "12"), 10) || 12;
          const expiryISO = new Date(Date.now() + hours*3600*1000).toISOString();

          if (!confirm(`Déverrouiller ${u.email} ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            status: 'active',
            locked: false,
            lockedAt: deleteField(),
            lockedBy: deleteField(),
            adminPopup: {
              status: 'active',
              type: 'unlockNotice',
              title: '✅ Compte réactivé',
              message: 'Votre accès a été rétabli.',
              details: `Réactivation par ${currentUser.email}.`,
              issuedAt: serverTimestamp(),
              expiryDate: expiryISO,
              issuedBy: currentUser.email
            }
            // on peut nettoyer le paymentWarning si tu veux : ajoute "paymentWarning: deleteField()"
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_UNLOCKED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Compte déverrouillé + popup info (${hours}h).`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Utilisateur ${u.email} déverrouillé.`);
        }
      } catch (e) {
        showAlert('error', e.message);
      }
    };

    // Avertissement paiement ON/OFF (24h par défaut)
    window.togglePaymentWarning = async (uid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');

      const isWarned = !!(u.paymentWarning && u.paymentWarning.status === 'active');

      try {
        if (isWarned) {
          if (!confirm(`Désactiver l'avertissement paiement pour ${u.email} ?`)) return;
          await updateDoc(doc(db, 'users', uid), { paymentWarning: deleteField() });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'PAYMENT_WARNING_DISABLED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Avertissement de paiement désactivé.`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Avertissement désactivé pour ${u.email}.`);
        } else {
          const hours = parseInt(prompt("Durée (heures)", "24"), 10) || 24;
          const expiryISO = new Date(Date.now() + hours*3600*1000).toISOString();
          if (!confirm(`Envoyer AVERTISSEMENT de paiement à ${u.email} (${hours}h) ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            paymentWarning: {
              status: 'active',
              issuedAt: serverTimestamp(),
              expiryDate: expiryISO,
              issuedBy: currentUser.email,
              reason: 'payment'
            }
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'PAYMENT_WARNING_SENT',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: u.email,
            details: `Avertissement paiement envoyé (${hours}h).`,
            timestamp: serverTimestamp()
          });

          showAlert('success', `Avertissement envoyé à ${u.email}.`);
        }
      } catch (e) {
        showAlert('error', e.message);
      }
    };

    // ---- init UI/auth ----
    el.loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      el.loginBtn.disabled = true;
      el.loginBtn.textContent = 'Connexion...';
      signInWithEmailAndPassword(auth, el.email.value, el.password.value)
        .catch(err => showAlert('error', err.message))
        .finally(() => {
          el.loginBtn.disabled = false;
          el.loginBtn.textContent = 'Connexion';
        });
    });
    el.logoutBtn.addEventListener('click', () => signOut(auth));

    el.searchUsers.addEventListener('input', renderUsers);
    el.roleFilter.addEventListener('change', renderUsers);
    el.statusFilter.addEventListener('change', renderUsers);

    onAuthStateChanged(auth, (user) => {
      updateUI(user);
    });
  </script>
</body>
</html>
