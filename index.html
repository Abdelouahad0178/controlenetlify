<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Administration S√©curis√©e - Anapharmo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2b;--line:#203054;--brand:#1a2a4a;--brand2:#2b406b;
      --ok:#b7ffc3;--bad:#ffb4b4;--warning:#ffd93d;--text:#eaeef7;--muted:#8892b0;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial;line-height:1.5}
    
    header{padding:16px 24px;background:#15223a;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--line)}
    h1{margin:0;font-size:24px;font-weight:600}
    
    .card{background:var(--panel);border:1px solid #223355;border-radius:14px;padding:20px;margin:16px;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
    .card h2{margin-top:0;color:var(--text);font-size:18px}
    
    input,button,select,textarea{border-radius:8px;border:1px solid var(--brand2);background:#0e1830;color:#fff;padding:10px 16px;font-size:14px}
    button{background:var(--brand);cursor:pointer;transition:all 0.2s;font-weight:500}
    button:hover{filter:brightness(1.2);transform:translateY(-1px)}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    button.danger{background:#dc2626;border-color:#dc2626}
    button.success{background:#059669;border-color:#059669}
    button.warning{background:#f59e0b;border-color:#f59e0b}
    button.info{background:#3b82f6;border-color:#3b82f6}
    button.payment{background:#ff6600;border-color:#ff6600;color:white}
    
    .hidden{display:none !important}
    .loading{opacity:0.6;pointer-events:none}
    
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;font-size:14px}
    th{background:rgba(26,42,74,0.5);font-weight:600;color:var(--text)}
    tr:hover{background:rgba(32,48,84,0.3)}
    
    .status-active{color:var(--ok);font-weight:500}
    .status-disabled{color:var(--bad);font-weight:500}
    .status-warned{color:var(--warning);font-weight:500}
    
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 12px;border-radius:16px;border:1px solid var(--line);font-size:12px;font-weight:500}
    .pill.admin{background:var(--brand);border-color:var(--brand)}
    .pill.user{background:rgba(139,146,176,0.2);border-color:var(--muted)}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-card{background:rgba(26,42,74,0.3);padding:16px;border-radius:8px;text-align:center}
    .stat-number{font-size:28px;font-weight:bold;color:var(--ok)}
    .stat-label{font-size:14px;color:var(--muted);margin-top:4px}
    
    .actions{display:flex;gap:6px}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-content{background:var(--panel);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    
    .logs-section{max-height:400px;overflow-y:auto;margin-top:16px}
    .log-entry{padding:8px 12px;margin:4px 0;background:rgba(32,48,84,0.2);border-radius:6px;font-size:13px}
    .log-timestamp{color:var(--muted);font-size:11px}
    
    .search-bar{width:100%;max-width:300px;margin-bottom:16px}
    .role-badge{padding:2px 8px;border-radius:12px;font-size:11px;font-weight:bold}
    .role-admin{background:#dc2626;color:white}
    .role-user{background:#6b7280;color:white}
    .role-moderator{background:#059669;color:white}
    
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:16px}
    .alert-success{background:rgba(5,150,105,0.2);border:1px solid #059669;color:var(--ok)}
    .alert-error{background:rgba(220,38,38,0.2);border:1px solid #dc2626;color:var(--bad)}
    .alert-warning{background:rgba(255,217,61,0.2);border:1px solid #ffd93d;color:var(--warning)}
    .alert-info{background:rgba(59,130,246,0.2);border:1px solid #3b82f6;color:#3b82f6}

    .connection-status{display:flex;align-items:center;gap:8px;font-size:14px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--ok);transition:all 0.3s ease}
    .status-dot.offline{background:var(--bad);animation:pulse 2s infinite}
    .status-dot.connecting{background:var(--warning);animation:pulse 1s infinite}
    .status-dot.reconnecting{background:#ff6b35;animation:pulse 0.5s infinite}

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .login-form{display:flex;gap:12px;align-items:center}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-weight:bold}
    
    .auto-admin-notice{background:rgba(255,217,61,0.1);border:1px solid var(--warning);border-radius:8px;padding:12px;margin:16px 0;color:var(--warning)}

    /* Styles pour les avertissements de paiement */
    .payment-warning-badge{
      display:inline-flex;align-items:center;gap:4px;padding:2px 6px;
      border-radius:10px;background:rgba(245,158,11,0.2);border:1px solid #f59e0b;
      font-size:10px;color:var(--warning);font-weight:bold;
    }
    
    .countdown-timer{color:var(--warning);font-size:11px;font-weight:bold;}
    .expired-warning{color:var(--bad);font-size:11px;font-weight:bold;}
    
    .network-status{
      display:flex;align-items:center;gap:8px;padding:8px 12px;
      background:rgba(32,48,84,0.3);border-radius:8px;font-size:12px;
    }
    .network-quality{
      display:flex;gap:2px;align-items:end;
    }
    .network-bar{
      width:3px;height:8px;background:var(--muted);border-radius:1px;
    }
    .network-bar.active{background:var(--ok);}
    .network-bar.weak{background:var(--warning);}
    .network-bar.poor{background:var(--bad);}
    
    .offline-indicator{
      background:rgba(220,38,38,0.2);border:1px solid #dc2626;
      border-radius:8px;padding:8px 12px;margin:8px 0;color:var(--bad);
      font-size:12px;text-align:center;
    }
  </style>
</head>
<body>
  <header>
    <h1>üîê Administration Anapharmo</h1>
    <div id="authContainer">
      <form id="loginForm" class="login-form">
        <input id="email" type="email" placeholder="admin@email.com" autocomplete="username" required />
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />
        <button type="submit" id="loginBtn">Connexion</button>
      </form>
      
      <div id="userInfo" class="user-info hidden">
        <div class="network-status">
          <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">Connect√©</span>
          </div>
          <div class="network-quality">
            <div class="network-bar" id="bar1"></div>
            <div class="network-bar" id="bar2"></div>
            <div class="network-bar" id="bar3"></div>
            <div class="network-bar" id="bar4"></div>
          </div>
          <span id="networkQuality">Excellent</span>
        </div>
        <div class="user-avatar" id="userAvatar">A</div>
        <span id="userEmail">user@email.com</span>
        <button id="logoutBtn" class="danger">D√©connexion</button>
      </div>
    </div>
  </header>

  <div id="offlineIndicator" class="offline-indicator hidden">
    üåê Mode hors ligne - Reconnexion automatique en cours...
  </div>

  <div id="alertContainer"></div>

  <div class="card hidden" id="statsCard">
    <h2>üìä Tableau de bord</h2>
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">-</div>
        <div class="stat-label">Total utilisateurs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--ok)" id="activeUsers">-</div>
        <div class="stat-label">Utilisateurs actifs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--bad)" id="disabledUsers">-</div>
        <div class="stat-label">Utilisateurs d√©sactiv√©s</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--warning)" id="warnedUsers">-</div>
        <div class="stat-label">Avertis paiement</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--brand)" id="adminUsers">-</div>
        <div class="stat-label">Administrateurs</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üë• Gestion des utilisateurs</h2>
    
    <div id="adminInterface" class="hidden">
      <div class="auto-admin-notice">
        <strong>üîß Mode administrateur automatique activ√©</strong><br>
        Votre email (echchaaba0178@gmail.com) a automatiquement les droits administrateur.
      </div>
      
      <div class="toolbar">
        <input id="searchUsers" class="search-bar" placeholder="üîç Rechercher un utilisateur..." />
        <button id="refreshUsers">üîÑ Actualiser</button>
        <button id="toggleNetworkTestBtn" class="warning">üåê D√©sactiver tests r√©seau</button>
        <button id="createAdminProfileBtn" class="success">üëë Cr√©er mon profil admin</button>
        <button id="cleanupDataBtn" class="danger">üßπ Nettoyer les donn√©es</button>
        <button id="editCompanyBtn" class="success">üè¢ Modifier ma soci√©t√©</button>
        <select id="roleFilter">
          <option value="">Tous les r√¥les</option>
          <option value="admin">M√©decins/Admins</option>
          <option value="vendeuse">Vendeuses</option>
          <option value="moderator">Mod√©rateurs</option>
          <option value="user">Utilisateurs</option>
        </select>
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="active">Actifs</option>
          <option value="disabled">D√©sactiv√©s</option>
          <option value="warned">Avertis paiement</option>
        </select>
        <select id="companyFilter">
          <option value="">Toutes les soci√©t√©s</option>
        </select>
      </div>

      <div id="usersTableContainer">
        <table>
          <thead>
            <tr>
              <th>üë§ Utilisateur</th>
              <th>üìß Email</th>
              <th>üè¢ Soci√©t√©</th>
              <th>üè∑Ô∏è R√¥le</th>
              <th>üìä Statut</th>
              <th>üìÖ Cr√©√© le</th>
              <th>üîß Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>
    
    <div id="loginPrompt" class="alert alert-info">
      üîí <strong>Connexion requise</strong><br>
      Connectez-vous avec un compte administrateur pour g√©rer les utilisateurs.
    </div>
  </div>

  <div class="card hidden" id="logsCard">
    <h2>üìù Journal d'activit√©</h2>
    <div class="logs-section" id="logsContainer">
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        Aucune activit√© r√©cente
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal hidden">
    <div class="modal-content">
      <h3 id="modalTitle">Confirmation</h3>
      <p id="modalMessage">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
      <div class="toolbar" style="justify-content: flex-end; margin-top: 20px;">
        <button id="modalCancel">Annuler</button>
        <button id="modalConfirm" class="danger">Confirmer</button>
      </div>
    </div>
  </div>

  <div id="companyModal" class="modal hidden">
    <div class="modal-content">
      <h3>üè¢ Modifier le nom de soci√©t√©</h3>
      <p>Cette soci√©t√© sera associ√©e √† votre compte et √† tous vos employ√©s (vendeuses).</p>
      <div style="margin: 16px 0;">
        <label for="companyNameInput" style="display: block; margin-bottom: 8px;">Nom de la soci√©t√© :</label>
        <input id="companyNameInput" type="text" placeholder="Ex: Pharmacie Central, Cabinet Dr. Martin..." style="width: 100%;" />
      </div>
      <div class="alert alert-info" style="margin: 16px 0;">
        <strong>üí° Info :</strong> Ce nom appara√Ætra √† c√¥t√© de votre nom et de celui de vos vendeuses dans tout le syst√®me.
      </div>
      <div class="toolbar" style="justify-content: flex-end; margin-top: 20px;">
        <button id="companyCancel">Annuler</button>
        <button id="companyConfirm" class="success">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="roleModal" class="modal hidden">
    <div class="modal-content">
      <h3>Modifier le r√¥le utilisateur</h3>
      <p id="roleModalUser">Utilisateur: </p>
      <div style="margin: 16px 0;">
        <label for="newRoleSelect" style="display: block; margin-bottom: 8px;">Nouveau r√¥le :</label>
        <select id="newRoleSelect" style="width: 100%;">
          <option value="user">üë§ Utilisateur</option>
          <option value="vendeuse">üõí Vendeuse</option>
          <option value="moderator">üõ°Ô∏è Mod√©rateur</option>
          <option value="admin">üëë M√©decin/Admin</option>
        </select>
      </div>
      <div class="alert alert-warning" style="margin: 16px 0;">
        <strong>‚ö†Ô∏è Attention :</strong> Les changements de r√¥le prennent effet imm√©diatement.
      </div>
      <div class="toolbar" style="justify-content: flex-end; margin-top: 20px;">
        <button id="roleCancel">Annuler</button>
        <button id="roleConfirm" class="success">Modifier</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, limit, getDocs, where, setDoc, getDoc, serverTimestamp, addDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- üö® ALERTE S√âCURIT√â ---
    // Ne JAMAIS exposer vos cl√©s API directement dans le code client.
    // Utilisez des variables d'environnement et un outil de build (ex: Vite, Webpack)
    // ou chargez la configuration depuis une fonction backend s√©curis√©e.
    const firebaseConfig = {
      apiKey: "AIzaSyBHQSPXwED7W-FQMMs1D-OZcjW-5AP8A-w",
      authDomain: "anapharmo.firebaseapp.com",
      projectId: "anapharmo",
      storageBucket: "anapharmo.firebasestorage.app",
      messagingSenderId: "1097322827362",
      appId: "1:1097322827362:web:fd19a67d9af135dcbf4b3b",
      measurementId: "G-JX6HCRX075"
    };

    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- üîí NOTE DE S√âCURIT√â ---
    // La meilleure pratique est d'utiliser les "Custom Claims" de Firebase Auth
    // pour g√©rer les r√¥les de mani√®re s√©curis√©e c√¥t√© serveur.
    const ADMIN_EMAIL = "echchaaba0178@gmail.com";

    // --- √âl√©ments DOM ---
    const elements = {
      // Authentification
      loginForm: document.getElementById('loginForm'),
      userInfo: document.getElementById('userInfo'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      userEmail: document.getElementById('userEmail'),
      userAvatar: document.getElementById('userAvatar'),
      connectionDot: document.getElementById('connectionDot'),
      connectionStatus: document.getElementById('connectionStatus'),
      networkQuality: document.getElementById('networkQuality'),
      offlineIndicator: document.getElementById('offlineIndicator'),
      
      // Interface
      alertContainer: document.getElementById('alertContainer'),
      loginPrompt: document.getElementById('loginPrompt'),
      adminInterface: document.getElementById('adminInterface'),
      statsCard: document.getElementById('statsCard'),
      logsCard: document.getElementById('logsCard'),
      
      // Statistiques
      totalUsers: document.getElementById('totalUsers'),
      activeUsers: document.getElementById('activeUsers'),
      disabledUsers: document.getElementById('disabledUsers'),
      warnedUsers: document.getElementById('warnedUsers'),
      adminUsers: document.getElementById('adminUsers'),
      
      // Gestion utilisateurs
      searchUsers: document.getElementById('searchUsers'),
      refreshUsers: document.getElementById('refreshUsers'),
      toggleNetworkTestBtn: document.getElementById('toggleNetworkTestBtn'),
      createAdminProfileBtn: document.getElementById('createAdminProfileBtn'),
      cleanupDataBtn: document.getElementById('cleanupDataBtn'),
      editCompanyBtn: document.getElementById('editCompanyBtn'),
      roleFilter: document.getElementById('roleFilter'),
      statusFilter: document.getElementById('statusFilter'),
      companyFilter: document.getElementById('companyFilter'),
      usersTable: document.getElementById('usersTable'),
      logsContainer: document.getElementById('logsContainer'),
      
      // Modales
      confirmModal: document.getElementById('confirmModal'),
      roleModal: document.getElementById('roleModal'),
      companyModal: document.getElementById('companyModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalMessage: document.getElementById('modalMessage'),
      modalCancel: document.getElementById('modalCancel'),
      modalConfirm: document.getElementById('modalConfirm'),
      roleModalUser: document.getElementById('roleModalUser'),
      newRoleSelect: document.getElementById('newRoleSelect'),
      roleCancel: document.getElementById('roleCancel'),
      roleConfirm: document.getElementById('roleConfirm'),
      companyNameInput: document.getElementById('companyNameInput'),
      companyCancel: document.getElementById('companyCancel'),
      companyConfirm: document.getElementById('companyConfirm')
    };

    // --- Variables globales ---
    let currentUser = null;
    let isAdmin = false;
    let allUsers = [];
    let unsubscribeUsers = null;
    let unsubscribeLogs = null;
    let networkManager = null;
    
    // --- Utilitaires ---
    const showAlert = (type, message, duration = 5000) => {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `<strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${message}`;
      elements.alertContainer.appendChild(alert);
      setTimeout(() => alert.style.opacity = '0', duration - 500);
      setTimeout(() => alert.remove(), duration);
    };

    const formatDate = (timestamp) => {
      if (!timestamp) return 'N/A';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    };

    const formatRole = (role) => {
      const roleMap = {
        admin: { text: 'üë®‚Äç‚öïÔ∏è M√©decin/Admin', class: 'role-admin' },
        vendeuse: { text: 'üõí Vendeuse', class: 'role-moderator' },
        moderator: { text: 'üõ°Ô∏è Mod√©rateur', class: 'role-moderator' },
        user: { text: 'üë§ Utilisateur', class: 'role-user' }
      };
      const { text, class: className } = roleMap[role] || roleMap.user;
      return `<span class="role-badge ${className}">${text}</span>`;
    };
    
    // --- Logique principale ---
    
    /**
     * Met √† jour l'interface en fonction de l'√©tat de l'utilisateur (connect√©/d√©connect√©, admin/non-admin)
     */
    const updateUI = (user) => {
      if (user) {
        currentUser = user;
        isAdmin = user.email === ADMIN_EMAIL;
        
        elements.loginForm.classList.add('hidden');
        elements.userInfo.classList.remove('hidden');
        elements.loginPrompt.classList.add('hidden');
        
        elements.userEmail.textContent = user.email;
        elements.userAvatar.textContent = user.email.substring(0, 2).toUpperCase();
        
        if (isAdmin) {
          elements.adminInterface.classList.remove('hidden');
          elements.statsCard.classList.remove('hidden');
          elements.logsCard.classList.remove('hidden');
          listenToUsers();
          listenToLogs();
        } else {
          elements.adminInterface.classList.add('hidden');
          showAlert('warning', "Acc√®s non autoris√©. Seuls les administrateurs peuvent voir cette page.");
        }
      } else {
        currentUser = null;
        isAdmin = false;
        
        elements.loginForm.classList.remove('hidden');
        elements.userInfo.classList.add('hidden');
        elements.loginPrompt.classList.remove('hidden');
        elements.adminInterface.classList.add('hidden');
        elements.statsCard.classList.add('hidden');
        elements.logsCard.classList.add('hidden');
        
        if (unsubscribeUsers) unsubscribeUsers();
        if (unsubscribeLogs) unsubscribeLogs();
        allUsers = [];
        elements.usersTable.innerHTML = '';
      }
    };
    
    /**
     * Affiche les utilisateurs dans le tableau, en appliquant les filtres actifs
     * (inclut bouton d'avertissement togglable)
     */
    const renderUsers = () => {
      if (!isAdmin) return;

      const searchTerm = elements.searchUsers.value.toLowerCase();
      const roleFilter = elements.roleFilter.value;
      const statusFilter = elements.statusFilter.value;

      const filteredUsers = allUsers.filter(user => {
        const searchMatch =
          user.email.toLowerCase().includes(searchTerm) ||
          (user.displayName && user.displayName.toLowerCase().includes(searchTerm));
        const roleMatch = !roleFilter || user.role === roleFilter;
        const statusMatch =
          !statusFilter ||
          (statusFilter === 'active' && user.status === 'active') ||
          (statusFilter === 'disabled' && user.status === 'disabled') ||
          (statusFilter === 'warned' && user.paymentWarning && user.paymentWarning.status === 'active');
        return searchMatch && roleMatch && statusMatch;
      });

      if (filteredUsers.length === 0) {
        elements.usersTable.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
              Aucun utilisateur trouv√©.
            </td>
          </tr>`;
        return;
      }

      elements.usersTable.innerHTML = filteredUsers
        .map(user => {
          const isWarned = !!(user.paymentWarning && user.paymentWarning.status === 'active');
          const warnedBadge = isWarned ? `<span class="payment-warning-badge">Averti</span>` : '';
          return `
            <tr>
              <td>${user.displayName || 'N/A'} ${warnedBadge}</td>
              <td>${user.email}</td>
              <td>${user.companyName || 'N/A'}</td>
              <td>${formatRole(user.role)}</td>
              <td class="${user.status === 'active' ? 'status-active' : 'status-disabled'}">${user.status}</td>
              <td>${formatDate(user.createdAt)}</td>
              <td class="actions">
                <button class="${user.status === 'active' ? 'danger' : 'success'}"
                        onclick="window.toggleUserStatus('${user.uid}')">
                  ${user.status === 'active' ? 'üö´' : '‚úÖ'}
                </button>
                <button class="${isWarned ? 'payment' : 'warning'}"
                        title="${isWarned ? 'D√©sactiver l‚Äôavertissement' : 'Activer un avertissement 24h'}"
                        onclick="window.togglePaymentWarning('${user.uid}')">
                  ${isWarned ? 'üí∏ ON' : 'üí∞ OFF'}
                </button>
                <button class="info" onclick="window.openRoleModal('${user.uid}')">‚úèÔ∏è</button>
              </td>
            </tr>
          `;
        })
        .join('');
    };
    
    /**
     * Met √† jour les cartes de statistiques
     */
    const updateStats = () => {
      elements.totalUsers.textContent = allUsers.length;
      elements.activeUsers.textContent = allUsers.filter(u => u.status === 'active').length;
      elements.disabledUsers.textContent = allUsers.filter(u => u.status === 'disabled').length;
      elements.adminUsers.textContent = allUsers.filter(u => u.role === 'admin').length;
      elements.warnedUsers.textContent = allUsers.filter(u => u.paymentWarning && u.paymentWarning.status === 'active').length;
    };
    
    /**
     * √âcoute les changements dans la collection 'users' de Firestore
     */
    const listenToUsers = () => {
      if (unsubscribeUsers) unsubscribeUsers(); // √âvite les listeners multiples
      const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
      unsubscribeUsers = onSnapshot(q, (snapshot) => {
        allUsers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
        renderUsers();
        updateStats();
      }, (error) => {
        console.error("Erreur d'√©coute Firestore (users):", error);
        showAlert('error', "Impossible de charger les utilisateurs en temps r√©el.");
      });
    };
    
    /**
     * √âcoute les changements dans la collection 'admin_logs'
     */
    const listenToLogs = () => {
      if (unsubscribeLogs) unsubscribeLogs();
      const q = query(collection(db, "admin_logs"), orderBy("timestamp", "desc"), limit(50));
      unsubscribeLogs = onSnapshot(q, (snapshot) => {
        if(snapshot.empty) {
          elements.logsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">Aucune activit√© r√©cente</div>';
          return;
        }
        elements.logsContainer.innerHTML = snapshot.docs.map(doc => {
          const log = doc.data();
          return `<div class="log-entry">
              <span class="log-timestamp">${formatDate(log.timestamp)}</span> - 
              <strong>${log.adminEmail}</strong>: ${log.details}
          </div>`;
        }).join('');
      }, (error) => {
        console.error("Erreur d'√©coute Firestore (logs):", error);
      });
    };

    // --- Fonctions globales pour les boutons ---
    
    window.toggleUserStatus = async (uid) => {
      const user = allUsers.find(u => u.uid === uid);
      if (!user) return showAlert('error', 'Utilisateur non trouv√©.');

      const newStatus = user.status === 'active' ? 'disabled' : 'active';
      const action = newStatus === 'disabled' ? 'd√©sactiver' : 'activer';
      
      if (confirm(`√ätes-vous s√ªr de vouloir ${action} l'utilisateur ${user.email} ?`)) {
        try {
          await updateDoc(doc(db, 'users', uid), { status: newStatus });
          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_STATUS_CHANGED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: user.email,
            details: `Statut de ${user.email} chang√© √† ${newStatus}.`,
            timestamp: serverTimestamp()
          });
          showAlert('success', `Utilisateur ${action} avec succ√®s.`);
        } catch (error) {
          showAlert('error', `Erreur lors de la mise √† jour : ${error.message}`);
        }
      }
    };
    
    // Active un avertissement 24h (fonction existante utilis√©e par le toggle)
    window.handleSimplePaymentWarning = async (uid) => {
      const user = allUsers.find(u => u.uid === uid);
      if (!user) return showAlert('error', 'Utilisateur non trouv√©.');

      const confirmed = confirm(`üö® AVERTISSEMENT DE PAIEMENT\n\nEnvoyer un avertissement √† ${user.email} ?\n\nL'utilisateur aura 24h pour r√©gulariser sa situation avant que son compte ne soit suspendu.`);
      if (!confirmed) return;

      try {
        const expiryDate = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
        await updateDoc(doc(db, 'users', uid), {
          paymentWarning: {
            issuedAt: serverTimestamp(),
            expiryDate: expiryDate,
            status: 'active',
            issuedBy: currentUser.email
          }
        });
        await addDoc(collection(db, 'admin_logs'), {
          action: 'PAYMENT_WARNING_SENT',
          adminUid: currentUser.uid,
          adminEmail: currentUser.email,
          targetUid: uid,
          targetEmail: user.email,
          details: `Avertissement de paiement envoy√© √† ${user.email}.`,
          timestamp: serverTimestamp()
        });
        showAlert('success', `Avertissement envoy√© √† ${user.email}.`);
      } catch (error) {
        showAlert('error', `Erreur lors de l'envoi de l'avertissement: ${error.message}`);
      }
    };

    // üîÅ Bouton Avertissement TOGGLE (ON/OFF)
    window.togglePaymentWarning = async (uid) => {
      const user = allUsers.find(u => u.uid === uid);
      if (!user) return showAlert('error', 'Utilisateur non trouv√©.');

      const isWarned = !!(user.paymentWarning && user.paymentWarning.status === 'active');

      try {
        if (isWarned) {
          // üî¥ D√©sactiver l‚Äôavertissement
          await updateDoc(doc(db, 'users', uid), {
            'paymentWarning.status': 'inactive',
            'paymentWarning.clearedAt': serverTimestamp(),
            'paymentWarning.clearedBy': currentUser.email,
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'PAYMENT_WARNING_DISABLED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: user.email,
            details: `Avertissement de paiement d√©sactiv√© pour ${user.email}.`,
            timestamp: serverTimestamp(),
          });

          showAlert('success', `Avertissement d√©sactiv√© pour ${user.email}.`);
        } else {
          // üü° Activer l‚Äôavertissement (24h)
          await window.handleSimplePaymentWarning(uid);
        }
      } catch (error) {
        showAlert('error', `Erreur: ${error.message}`);
      }
    };
    
    window.openRoleModal = (uid) => {
      const user = allUsers.find(u => u.uid === uid);
      if (!user) return;
      
      elements.roleModalUser.textContent = `Utilisateur: ${user.email}`;
      elements.newRoleSelect.value = user.role || 'user';
      elements.roleModal.dataset.uid = uid; // Stocker l'UID pour la confirmation
      elements.roleModal.classList.remove('hidden');
    };

    // --- Initialisation ---
    document.addEventListener('DOMContentLoaded', () => {
      // Logique de connexion
      elements.loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        elements.loginBtn.disabled = true;
        elements.loginBtn.textContent = 'Connexion...';

        signInWithEmailAndPassword(auth, elements.email.value, elements.password.value)
          .catch(error => showAlert('error', `√âchec de la connexion : ${error.code === 'auth/invalid-credential' ? 'Identifiants invalides' : error.message}`))
          .finally(() => {
            elements.loginBtn.disabled = false;
            elements.loginBtn.textContent = 'Connexion';
          });
      });
      
      // Logique de d√©connexion
      elements.logoutBtn.addEventListener('click', () => signOut(auth));
      
      // Listeners pour les filtres
      elements.searchUsers.addEventListener('input', renderUsers);
      elements.roleFilter.addEventListener('change', renderUsers);
      elements.statusFilter.addEventListener('change', renderUsers);
      
      // Gestion de la modale de r√¥le
      elements.roleCancel.addEventListener('click', () => elements.roleModal.classList.add('hidden'));
      elements.roleConfirm.addEventListener('click', async () => {
        const uid = elements.roleModal.dataset.uid;
        const newRole = elements.newRoleSelect.value;
        const user = allUsers.find(u => u.uid === uid);
        if (!uid || !user) return;

        try {
          await updateDoc(doc(db, 'users', uid), { role: newRole });
          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_ROLE_CHANGED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            targetEmail: user.email,
            details: `R√¥le de ${user.email} chang√© √† ${newRole}.`,
            timestamp: serverTimestamp()
          });
          showAlert('success', 'R√¥le mis √† jour.');
          elements.roleModal.classList.add('hidden');
        } catch (error) {
          showAlert('error', `Erreur: ${error.message}`);
        }
      });

      // √âcouter l'√©tat d'authentification pour d√©marrer l'app
      onAuthStateChanged(auth, user => updateUI(user));
    });

  </script>
</body>
</html>
