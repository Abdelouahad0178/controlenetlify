<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Administration S√©curis√©e - Anapharmo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2b;--line:#203054;--brand:#1a2a4a;--brand2:#2b406b;
      --ok:#b7ffc3;--bad:#ffb4b4;--warning:#ffd93d;--text:#eaeef7;--muted:#8892b0;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial;line-height:1.5}
    
    header{padding:16px 24px;background:#15223a;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--line)}
    h1{margin:0;font-size:24px;font-weight:600}
    
    .card{background:var(--panel);border:1px solid #223355;border-radius:14px;padding:20px;margin:16px;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
    .card h2{margin-top:0;color:var(--text);font-size:18px}
    
    input,button,select,textarea{border-radius:8px;border:1px solid var(--brand2);background:#0e1830;color:#fff;padding:10px 16px;font-size:14px}
    button{background:var(--brand);cursor:pointer;transition:all 0.2s;font-weight:500}
    button:hover{filter:brightness(1.2);transform:translateY(-1px)}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    button.danger{background:#dc2626;border-color:#dc2626}
    button.success{background:#059669;border-color:#059669}
    button.warning{background:#f59e0b;border-color:#f59e0b}
    button.info{background:#3b82f6;border-color:#3b82f6}
    button.payment{background:#ff6600;border-color:#ff6600;color:white}
    
    .hidden{display:none !important}
    .loading{opacity:0.6;pointer-events:none}
    
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;font-size:14px}
    th{background:rgba(26,42,74,0.5);font-weight:600;color:var(--text)}
    tr:hover{background:rgba(32,48,84,0.3)}
    
    .status-active{color:var(--ok);font-weight:500}
    .status-disabled{color:var(--bad);font-weight:500}
    .status-warned{color:var(--warning);font-weight:500}
    
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 12px;border-radius:16px;border:1px solid var(--line);font-size:12px;font-weight:500}
    .pill.admin{background:var(--brand);border-color:var(--brand)}
    .pill.user{background:rgba(139,146,176,0.2);border-color:var(--muted)}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-card{background:rgba(26,42,74,0.3);padding:16px;border-radius:8px;text-align:center}
    .stat-number{font-size:28px;font-weight:bold;color:var(--ok)}
    .stat-label{font-size:14px;color:var(--muted);margin-top:4px}
    
    .actions{display:flex;gap:6px}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-content{background:var(--panel);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    
    .logs-section{max-height:400px;overflow-y:auto;margin-top:16px}
    .log-entry{padding:8px 12px;margin:4px 0;background:rgba(32,48,84,0.2);border-radius:6px;font-size:13px}
    .log-timestamp{color:var(--muted);font-size:11px}
    
    .search-bar{width:100%;max-width:300px;margin-bottom:16px}
    .role-badge{padding:2px 8px;border-radius:12px;font-size:11px;font-weight:bold}
    .role-admin{background:#dc2626;color:white}
    .role-user{background:#6b7280;color:white}
    .role-moderator{background:#059669;color:white}
    
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:16px}
    .alert-success{background:rgba(5,150,105,0.2);border:1px solid #059669;color:var(--ok)}
    .alert-error{background:rgba(220,38,38,0.2);border:1px solid #dc2626;color:var(--bad)}
    .alert-warning{background:rgba(255,217,61,0.2);border:1px solid #ffd93d;color:var(--warning)}
    .alert-info{background:rgba(59,130,246,0.2);border:1px solid #3b82f6;color:#3b82f6}

    .connection-status{display:flex;align-items:center;gap:8px;font-size:14px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--ok);transition:all 0.3s ease}
    .status-dot.offline{background:var(--bad);animation:pulse 2s infinite}
    .status-dot.connecting{background:var(--warning);animation:pulse 1s infinite}
    .status-dot.reconnecting{background:#ff6b35;animation:pulse 0.5s infinite}

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .login-form{display:flex;gap:12px;align-items:center}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-weight:bold}
    
    .auto-admin-notice{background:rgba(255,217,61,0.1);border:1px solid var(--warning);border-radius:8px;padding:12px;margin:16px 0;color:var(--warning)}

    /* Styles pour les avertissements de paiement */
    .payment-warning-badge{
      display:inline-flex;align-items:center;gap:4px;padding:2px 6px;
      border-radius:10px;background:rgba(245,158,11,0.2);border:1px solid #f59e0b;
      font-size:10px;color:var(--warning);font-weight:bold;
    }
    
    .countdown-timer{color:var(--warning);font-size:11px;font-weight:bold;}
    .expired-warning{color:var(--bad);font-size:11px;font-weight:bold;}
    
    .network-status{
      display:flex;align-items:center;gap:8px;padding:8px 12px;
      background:rgba(32,48,84,0.3);border-radius:8px;font-size:12px;
    }
    .network-quality{
      display:flex;gap:2px;align-items:end;
    }
    .network-bar{
      width:3px;height:8px;background:var(--muted);border-radius:1px;
    }
    .network-bar.active{background:var(--ok);}
    .network-bar.weak{background:var(--warning);}
    .network-bar.poor{background:var(--bad);}
    
    .offline-indicator{
      background:rgba(220,38,38,0.2);border:1px solid #dc2626;
      border-radius:8px;padding:8px 12px;margin:8px 0;color:var(--bad);
      font-size:12px;text-align:center;
    }
  </style>
</head>
<body>
  <header>
    <h1>üîê Administration Anapharmo</h1>
    <div id="authContainer">
      <!-- Formulaire de connexion -->
      <form id="loginForm" class="login-form hidden">
        <input id="email" type="email" placeholder="admin@email.com" autocomplete="username" required />
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />
        <button type="submit" id="loginBtn">Connexion</button>
      </form>
      
      <!-- Informations utilisateur connect√© -->
      <div id="userInfo" class="user-info hidden">
        <div class="network-status">
          <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">Connect√©</span>
          </div>
          <div class="network-quality">
            <div class="network-bar" id="bar1"></div>
            <div class="network-bar" id="bar2"></div>
            <div class="network-bar" id="bar3"></div>
            <div class="network-bar" id="bar4"></div>
          </div>
          <span id="networkQuality">Excellent</span>
        </div>
        <div class="user-avatar" id="userAvatar">A</div>
        <span id="userEmail">user@email.com</span>
        <button id="logoutBtn" class="danger">D√©connexion</button>
      </div>
    </div>
  </header>

  <!-- Indicateur hors ligne -->
  <div id="offlineIndicator" class="offline-indicator hidden">
    üåê Mode hors ligne - Reconnexion automatique en cours...
  </div>

  <!-- Conteneur pour les alertes -->
  <div id="alertContainer"></div>

  <!-- Section des statistiques -->
  <div class="card hidden" id="statsCard">
    <h2>üìä Tableau de bord</h2>
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">-</div>
        <div class="stat-label">Total utilisateurs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--ok)" id="activeUsers">-</div>
        <div class="stat-label">Utilisateurs actifs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--bad)" id="disabledUsers">-</div>
        <div class="stat-label">Utilisateurs d√©sactiv√©s</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--warning)" id="warnedUsers">-</div>
        <div class="stat-label">Avertis paiement</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--brand)" id="adminUsers">-</div>
        <div class="stat-label">Administrateurs</div>
      </div>
    </div>
  </div>

  <!-- Section de gestion des utilisateurs -->
  <div class="card">
    <h2>üë• Gestion des utilisateurs</h2>
    
    <!-- Message de statut -->
    <div id="statusMessage"></div>

    <!-- Interface d'administration -->
    <div id="adminInterface" class="hidden">
      <div class="auto-admin-notice">
        <strong>üîß Mode administrateur automatique activ√©</strong><br>
        Votre email (echchaaba0178@gmail.com) a automatiquement les droits administrateur.
      </div>
      
      <div class="toolbar">
        <input id="searchUsers" class="search-bar" placeholder="üîç Rechercher un utilisateur..." />
        <button id="refreshUsers">üîÑ Actualiser</button>
        <button id="toggleNetworkTestBtn" class="warning">üåê D√©sactiver tests r√©seau</button>
        <button id="createAdminProfileBtn" class="success">üëë Cr√©er mon profil admin</button>
        <button id="cleanupDataBtn" class="danger">üßπ Nettoyer les donn√©es</button>
        <button id="editCompanyBtn" class="success">üè¢ Modifier ma soci√©t√©</button>
        <select id="roleFilter">
          <option value="">Tous les r√¥les</option>
          <option value="admin">M√©decins/Admins</option>
          <option value="vendeuse">Vendeuses</option>
          <option value="moderator">Mod√©rateurs</option>
          <option value="user">Utilisateurs</option>
        </select>
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="active">Actifs</option>
          <option value="disabled">D√©sactiv√©s</option>
          <option value="warned">Avertis paiement</option>
        </select>
        <select id="companyFilter">
          <option value="">Toutes les soci√©t√©s</option>
        </select>
      </div>

      <div id="usersTableContainer">
        <table>
          <thead>
            <tr>
              <th>üë§ Utilisateur</th>
              <th>üìß Email</th>
              <th>üè¢ Soci√©t√©</th>
              <th>üè∑Ô∏è R√¥le</th>
              <th>üìä Statut</th>
              <th>üìÖ Cr√©√© le</th>
              <th>üîß Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                <div>Chargement des utilisateurs...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Message de connexion -->
    <div id="loginPrompt" class="alert alert-info">
      üîí <strong>Connexion requise</strong><br>
      Connectez-vous avec un compte administrateur pour g√©rer les utilisateurs.
    </div>
  </div>

  <!-- Section des logs -->
  <div class="card hidden" id="logsCard">
    <h2>üìù Journal d'activit√©</h2>
    <div class="logs-section" id="logsContainer">
      <div style="text-align: center; padding: 20px; color: var(--muted);">
        Aucune activit√© r√©cente
      </div>
    </div>
  </div>

  <!-- Modal de confirmation -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content">
      <h3 id="modalTitle">Confirmation</h3>
      <p id="modalMessage">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
      <div class="toolbar" style="justify-content: flex-end; margin-top: 20px;">
        <button id="modalCancel">Annuler</button>
        <button id="modalConfirm" class="danger">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Modal de changement de soci√©t√© -->
  <div id="companyModal" class="modal hidden">
    <div class="modal-content">
      <h3>üè¢ Modifier le nom de soci√©t√©</h3>
      <p>Cette soci√©t√© sera associ√©e √† votre compte et √† tous vos employ√©s (vendeuses).</p>
      <div style="margin: 16px 0;">
        <label for="companyNameInput" style="display: block; margin-bottom: 8px;">Nom de la soci√©t√© :</label>
        <input id="companyNameInput" type="text" placeholder="Ex: Pharmacie Central, Cabinet Dr. Martin..." style="width: 100%;" />
      </div>
      <div class="alert alert-info" style="margin: 16px 0;">
        <strong>üí° Info :</strong> Ce nom appara√Ætra √† c√¥t√© de votre nom et de celui de vos vendeuses dans tout le syst√®me.
      </div>
      <div class="toolbar" style="justify-content: flex-end; margin-top: 20px;">
        <button id="companyCancel">Annuler</button>
        <button id="companyConfirm" class="success">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal de changement de r√¥le -->
  <div id="roleModal" class="modal hidden">
    <div class="modal-content">
      <h3>Modifier le r√¥le utilisateur</h3>
      <p id="roleModalUser">Utilisateur: </p>
      <div style="margin: 16px 0;">
        <label for="newRoleSelect" style="display: block; margin-bottom: 8px;">Nouveau r√¥le :</label>
        <select id="newRoleSelect" style="width: 100%;">
          <option value="user">üë§ Utilisateur</option>
          <option value="vendeuse">üõí Vendeuse</option>
          <option value="moderator">üõ°Ô∏è Mod√©rateur</option>
          <option value="admin">üëë M√©decin/Admin</option>
        </select>
      </div>
      <div class="alert alert-warning" style="margin: 16px 0;">
        <strong>‚ö†Ô∏è Attention :</strong> Les changements de r√¥le prennent effet imm√©diatement.
      </div>
      <div class="toolbar" style="justify-content: flex-end; margin-top: 20px;">
        <button id="roleCancel">Annuler</button>
        <button id="roleConfirm" class="success">Modifier</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, limit, getDocs, where, setDoc, getDoc, serverTimestamp, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBHQSPXwED7W-FQMMs1D-OZcjW-5AP8A-w",
      authDomain: "anapharmo.firebaseapp.com",
      projectId: "anapharmo",
      storageBucket: "anapharmo.firebasestorage.app",
      messagingSenderId: "1097322827362",
      appId: "1:1097322827362:web:fd19a67d9af135dcbf4b3b",
      measurementId: "G-JX6HCRX075"
    };

    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Email administrateur autoris√©
    const ADMIN_EMAIL = "echchaaba0178@gmail.com";

    // √âl√©ments DOM
    const elements = {
      // Authentification
      loginForm: document.getElementById('loginForm'),
      userInfo: document.getElementById('userInfo'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      userEmail: document.getElementById('userEmail'),
      userAvatar: document.getElementById('userAvatar'),
      connectionDot: document.getElementById('connectionDot'),
      connectionStatus: document.getElementById('connectionStatus'),
      networkQuality: document.getElementById('networkQuality'),
      offlineIndicator: document.getElementById('offlineIndicator'),
      
      // Interface
      alertContainer: document.getElementById('alertContainer'),
      statusMessage: document.getElementById('statusMessage'),
      loginPrompt: document.getElementById('loginPrompt'),
      adminInterface: document.getElementById('adminInterface'),
      statsCard: document.getElementById('statsCard'),
      logsCard: document.getElementById('logsCard'),
      
      // Statistiques
      totalUsers: document.getElementById('totalUsers'),
      activeUsers: document.getElementById('activeUsers'),
      disabledUsers: document.getElementById('disabledUsers'),
      warnedUsers: document.getElementById('warnedUsers'),
      adminUsers: document.getElementById('adminUsers'),
      
      // Gestion utilisateurs
      searchUsers: document.getElementById('searchUsers'),
      refreshUsers: document.getElementById('refreshUsers'),
      toggleNetworkTestBtn: document.getElementById('toggleNetworkTestBtn'),
      createAdminProfileBtn: document.getElementById('createAdminProfileBtn'),
      cleanupDataBtn: document.getElementById('cleanupDataBtn'),
      editCompanyBtn: document.getElementById('editCompanyBtn'),
      roleFilter: document.getElementById('roleFilter'),
      statusFilter: document.getElementById('statusFilter'),
      companyFilter: document.getElementById('companyFilter'),
      usersTable: document.getElementById('usersTable'),
      logsContainer: document.getElementById('logsContainer'),
      
      // Modales
      confirmModal: document.getElementById('confirmModal'),
      roleModal: document.getElementById('roleModal'),
      companyModal: document.getElementById('companyModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalMessage: document.getElementById('modalMessage'),
      modalCancel: document.getElementById('modalCancel'),
      modalConfirm: document.getElementById('modalConfirm'),
      roleModalUser: document.getElementById('roleModalUser'),
      newRoleSelect: document.getElementById('newRoleSelect'),
      roleCancel: document.getElementById('roleCancel'),
      roleConfirm: document.getElementById('roleConfirm'),
      companyNameInput: document.getElementById('companyNameInput'),
      companyCancel: document.getElementById('companyCancel'),
      companyConfirm: document.getElementById('companyConfirm')
    };

    // Variables globales avec gestion r√©seau am√©lior√©e
    let currentUser = null;
    let isAdmin = false;
    let allUsers = [];
    let unsubscribeUsers = null;
    let unsubscribeLogs = null;
    let pendingAction = null;
    let isOnline = navigator.onLine;
    let networkQuality = 'excellent';
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let lastDataUpdate = Date.now();

    // Gestion du r√©seau am√©lior√©e
    class NetworkManager {
      constructor() {
        this.listeners = [];
        this.retryTimeouts = new Map();
        this.connectionCheckInterval = null;
        this.lastSuccessfulOperation = Date.now();
        this.enableNetworkTesting = true;
        this.testCount = 0;
        this.maxTests = 10;
        
        window.addEventListener('online', () => this.handleOnline());
        window.addEventListener('offline', () => this.handleOffline());
        
        this.startConnectionMonitoring();
      }

      startConnectionMonitoring() {
        setTimeout(() => {
          if (this.enableNetworkTesting && this.testCount < this.maxTests) {
            this.checkNetworkQuality();
          }
        }, 10000);
        
        this.connectionCheckInterval = setInterval(() => {
          if (this.enableNetworkTesting && this.testCount < this.maxTests) {
            this.checkNetworkQuality();
            this.testCount++;
            
            if (this.testCount >= this.maxTests) {
              console.log('üåê Tests de connectivit√© automatiques d√©sactiv√©s (limite atteinte)');
              this.enableNetworkTesting = false;
            }
          }
        }, 120000);
      }

      async checkNetworkQuality() {
        try {
          const start = Date.now();
          
          const testEndpoints = [
            'https://www.google.com/favicon.ico',
            'https://firestore.googleapis.com/favicon.ico',
            'https://www.gstatic.com/images/branding/product/1x/firebase_16dp.png'
          ];
          
          let response;
          let testUrl = testEndpoints[0];
          
          try {
            response = await fetch(testUrl, {
              cache: 'no-cache',
              mode: 'no-cors',
              method: 'HEAD'
            });
          } catch (firstError) {
            try {
              testUrl = testEndpoints[1];
              response = await fetch(testUrl, {
                cache: 'no-cache',
                mode: 'no-cors',
                method: 'HEAD'
              });
            } catch (secondError) {
              testUrl = 'https://firebase.google.com/favicon.ico';
              response = await fetch(testUrl, {
                cache: 'no-cache',
                mode: 'no-cors',
                method: 'HEAD'
              });
            }
          }
          
          const duration = Date.now() - start;
          
          if (duration < 300) {
            this.updateNetworkQuality('excellent');
          } else if (duration < 800) {
            this.updateNetworkQuality('good');
          } else if (duration < 2000) {
            this.updateNetworkQuality('fair');
          } else {
            this.updateNetworkQuality('poor');
          }
          
          this.lastSuccessfulOperation = Date.now();
          console.log(`üåê Test r√©seau: ${duration}ms via ${testUrl}`);
          
        } catch (error) {
          if (this.testCount < 3) {
            console.warn('‚ö†Ô∏è Test r√©seau √©chou√©:', error.message);
          }
          
          if (navigator.onLine) {
            this.updateNetworkQuality('poor');
          } else {
            this.updateNetworkQuality('offline');
          }
        }
      }

      disableNetworkTesting() {
        this.enableNetworkTesting = false;
        if (this.connectionCheckInterval) {
          clearInterval(this.connectionCheckInterval);
          this.connectionCheckInterval = null;
        }
        console.log('üåê Tests de connectivit√© d√©sactiv√©s manuellement');
        this.updateNetworkQuality('good');
      }

      enableNetworkTesting() {
        this.enableNetworkTesting = true;
        this.testCount = 0;
        this.startConnectionMonitoring();
        console.log('üåê Tests de connectivit√© r√©activ√©s');
      }

      updateNetworkQuality(quality) {
        networkQuality = quality;
        this.updateNetworkDisplay();
      }

      updateNetworkDisplay() {
        const bars = [
          document.getElementById('bar1'),
          document.getElementById('bar2'), 
          document.getElementById('bar3'),
          document.getElementById('bar4')
        ];

        bars.forEach(bar => bar.className = 'network-bar');

        switch (networkQuality) {
          case 'excellent':
            bars.forEach(bar => bar.classList.add('active'));
            elements.networkQuality.textContent = 'Excellent';
            break;
          case 'good':
            bars.slice(0, 3).forEach(bar => bar.classList.add('active'));
            elements.networkQuality.textContent = 'Bon';
            break;
          case 'fair':
            bars.slice(0, 2).forEach(bar => bar.classList.add('weak'));
            elements.networkQuality.textContent = 'Moyen';
            break;
          case 'poor':
            bars[0].classList.add('poor');
            elements.networkQuality.textContent = 'Faible';
            break;
          case 'offline':
            elements.networkQuality.textContent = 'Hors ligne';
            break;
        }
      }

      handleOnline() {
        console.log('üåê Connexion r√©tablie');
        isOnline = true;
        elements.offlineIndicator.classList.add('hidden');
        setConnectionStatus('connected');
        this.retryFailedOperations();
      }

      handleOffline() {
        console.log('üåê Connexion perdue');
        isOnline = false;
        elements.offlineIndicator.classList.remove('hidden');
        setConnectionStatus('offline');
      }

      retryFailedOperations() {
        if (isAdmin && !unsubscribeUsers) {
          console.log('üîÑ Reconnexion des listeners Firestore...');
          setTimeout(() => {
            if (isAdmin) {
              listenToUsers();
              listenToLogs();
            }
          }, 1000);
        }
      }

      async executeWithRetry(operation, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            const result = await operation();
            return result;
          } catch (error) {
            console.warn(`Tentative ${attempt}/${maxRetries} √©chou√©e:`, error.message);
            
            if (attempt === maxRetries) {
              throw error;
            }
            
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
    }

    const networkManager = new NetworkManager();

    // Utilitaires
    function showAlert(type, message, duration = 5000) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `<strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${message}`;
      elements.alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, duration);
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Jamais';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatRole(role) {
      const roleMap = {
        admin: { text: 'üë®‚Äç‚öïÔ∏è M√©decin', class: 'role-admin' },
        vendeuse: { text: 'üõí Vendeuse', class: 'role-moderator' },
        moderator: { text: 'üõ°Ô∏è Mod√©rateur', class: 'role-moderator' },
        user: { text: 'üë§ Utilisateur', class: 'role-user' }
      };
      const roleInfo = roleMap[role] || roleMap.user;
      
      const isNonStandard = !['admin', 'vendeuse', 'moderator', 'user'].includes(role);
      const badge = `<span class="role-badge ${roleInfo.class}">${roleInfo.text}${isNonStandard ? ' ‚ö†Ô∏è' : ''}</span>`;
      
      return badge;
    }

    function formatCompany(company, role) {
      if (!company) return '';
      
      const icon = role === 'owner' ? 'üëë' : 'üè¢';
      return `<span class="pill" style="background: rgba(59,130,246,0.2); color: #3b82f6; font-size: 10px;">${icon} ${company}</span>`;
    }

    function getUserInitials(user) {
      if (user.displayName) {
        return user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
      }
      if (user.email) {
        return user.email.substring(0, 2).toUpperCase();
      }
      return '??';
    }

    function setConnectionStatus(status) {
      const statusMap = {
        connected: { dot: 'status-dot', text: 'Connect√©', color: 'var(--ok)' },
        connecting: { dot: 'status-dot connecting', text: 'Connexion...', color: 'var(--warning)' },
        reconnecting: { dot: 'status-dot reconnecting', text: 'Reconnexion...', color: '#ff6b35' },
        offline: { dot: 'status-dot offline', text: 'Hors ligne', color: 'var(--bad)' }
      };
      
      const statusInfo = statusMap[status] || statusMap.offline;
      elements.connectionDot.className = statusInfo.dot;
      elements.connectionStatus.textContent = statusInfo.text;
      elements.connectionStatus.style.color = statusInfo.color;
    }

    // Fonctions pour les avertissements de paiement
    function getPaymentWarningStatus(user) {
      if (!user.paymentWarning) {
        return null;
      }
      
      const now = new Date();
      const expiryDate = new Date(user.paymentWarning.expiryDate);
      
      if (now > expiryDate) {
        return 'expired';
      }
      
      return 'active';
    }

    function formatPaymentWarning(user) {
      const warningStatus = getPaymentWarningStatus(user);
      
      if (!warningStatus) {
        return '';
      }
      
      const now = new Date();
      const expiryDate = new Date(user.paymentWarning.expiryDate);
      const timeLeft = expiryDate - now;
      
      if (warningStatus === 'expired') {
        return `<div class="payment-warning-badge expired-warning">‚è∞ D√©lai expir√©</div>`;
      }
      
      const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      
      let timeDisplay = '';
      if (days > 0) {
        timeDisplay = `${days}j ${hours}h`;
      } else if (hours > 0) {
        timeDisplay = `${hours}h ${minutes}m`;
      } else {
        timeDisplay = `${minutes}m`;
      }
      
      return `<div class="payment-warning-badge countdown-timer">üí∞ ${timeDisplay}</div>`;
    }

    // NOUVELLE FONCTION SIMPLE POUR L'AVERTISSEMENT DE PAIEMENT
    window.handleSimplePaymentWarning = async (uid) => {
      console.log('üö® Avertissement de paiement simple pour:', uid);
      
      if (!uid || uid === 'undefined') {
        showAlert('error', 'Erreur: ID utilisateur invalide');
        return;
      }
      
      const user = allUsers.find(u => u.uid === uid);
      if (!user) {
        showAlert('error', 'Utilisateur non trouv√©');
        return;
      }
      
      // Confirmation simple
      const userName = user.displayName || user.email.split('@')[0];
      const confirmed = confirm(`üö® AVERTISSEMENT DE PAIEMENT\n\nEnvoyer un avertissement de paiement √† ${userName} ?\n\nMessage : "Votre acc√®s sera suspendu sous 24h si le paiement n'est pas effectu√©. Risque de perte de donn√©es."`);
      
      if (!confirmed) {
        return;
      }
      
      try {
        // Cr√©er l'avertissement avec 24h de d√©lai
        const expiryDate = new Date(Date.now() + (24 * 60 * 60 * 1000)); // 24 heures
        const warningMessage = `üö® AVERTISSEMENT DE PAIEMENT\n\nVotre acc√®s sera automatiquement suspendu dans 24 heures si votre paiement n'est pas effectu√©.\n\n‚ö†Ô∏è ATTENTION : Risque de perte de donn√©es apr√®s suspension.\n\nMerci de r√©gulariser votre situation rapidement.\n\nL'√©quipe Anapharmo`;
        
        await networkManager.executeWithRetry(async () => {
          // Mettre √† jour l'utilisateur
          await updateDoc(doc(db, 'users', uid), {
            paymentWarning: {
              issuedAt: serverTimestamp(),
              expiryDate: expiryDate.toISOString(),
              duration: 24, // 24 heures
              message: warningMessage,
              issuedBy: currentUser.uid,
              issuedByEmail: currentUser.email,
              status: 'active',
              type: 'simple' // Marqueur pour diff√©rencier les avertissements simples
            },
            updatedAt: serverTimestamp()
          });
          
          // Cr√©er le log
          await addDoc(collection(db, 'admin_logs'), {
            action: 'SIMPLE_PAYMENT_WARNING_SENT',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            details: {
              userEmail: user.email,
              userName: userName,
              duration: '24 heures',
              expiryDate: expiryDate.toISOString(),
              message: 'Avertissement de paiement standard - suspension sous 24h',
              automaticSuspension: true,
              warningType: 'simple'
            },
            timestamp: serverTimestamp()
          });
        });
        
        showAlert('success', `üö® Avertissement de paiement envoy√© √† ${userName}. Suspension automatique dans 24h.`);
        
        // Actualiser l'affichage
        setTimeout(() => {
          filterAndDisplayUsers();
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Erreur lors de l\'envoi de l\'avertissement:', error);
        showAlert('error', 'Erreur lors de l\'envoi de l\'avertissement: ' + error.message);
      }
    };

    // Fonction pour cr√©er automatiquement le profil admin
    async function createAdminProfile(user) {
      return networkManager.executeWithRetry(async () => {
        console.log("üîß Cr√©ation automatique du profil administrateur...");
        
        const adminData = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || 'M√©decin Principal',
          photoURL: user.photoURL || null,
          phoneNumber: user.phoneNumber || null,
          role: 'admin',
          disabled: false,
          isAdmin: true,
          company: 'Ma Soci√©t√©',
          companyRole: 'owner',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          lastLogin: serverTimestamp(),
          autoCreated: true,
          autoCreatedAt: new Date().toISOString()
        };
        
        await setDoc(doc(db, 'users', user.uid), adminData, { merge: true });
        console.log("‚úÖ Profil administrateur cr√©√© automatiquement");
        
        await createExampleUsers();
        return true;
      });
    }

    // Cr√©er des utilisateurs d'exemple avec retry
    async function createExampleUsers() {
      return networkManager.executeWithRetry(async () => {
        const existingExample = await getDocs(query(collection(db, 'users'), where('email', '==', 'sara@gmail.com'), limit(1)));
        
        if (existingExample.empty) {
          console.log("üìù Cr√©ation d'utilisateurs d'exemple...");
          
          await setDoc(doc(db, 'users', 'example-user-sara'), {
            uid: 'example-user-sara',
            email: 'sara@gmail.com',
            displayName: 'Sara Vendeuse',
            role: 'vendeuse',
            disabled: false,
            company: 'Ma Soci√©t√©',
            companyRole: 'employee',
            managedBy: currentUser?.uid,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            isExample: true
          });
          
          await setDoc(doc(db, 'users', 'example-user-test'), {
            uid: 'example-user-test',
            email: 'test@example.com',
            displayName: 'Utilisateur Test',
            role: 'moderator',
            disabled: true,
            company: 'Autre Soci√©t√©',
            companyRole: 'employee',
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            isExample: true
          });
          
          console.log("‚úÖ Utilisateurs d'exemple cr√©√©s");
        }
      });
    }

    // Gestion de l'authentification avec retry
    elements.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = elements.email.value.trim();
      const password = elements.password.value.trim();
      
      if (!email || !password) {
        showAlert('error', 'Veuillez remplir tous les champs');
        return;
      }

      elements.loginBtn.disabled = true;
      elements.loginBtn.textContent = 'Connexion...';
      setConnectionStatus('connecting');

      try {
        await networkManager.executeWithRetry(async () => {
          await signInWithEmailAndPassword(auth, email, password);
        });
        
        showAlert('success', 'Connexion r√©ussie');
        elements.email.value = '';
        elements.password.value = '';
      } catch (error) {
        console.error('Erreur de connexion:', error);
        
        let errorMessage = 'Erreur de connexion';
        switch (error.code) {
          case 'auth/invalid-credential':
          case 'auth/wrong-password':
          case 'auth/user-not-found':
            errorMessage = 'Email ou mot de passe incorrect';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Trop de tentatives. R√©essayez plus tard';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Probl√®me de connexion r√©seau';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Adresse email invalide';
            break;
          default:
            errorMessage = `Erreur: ${error.message}`;
        }
        
        showAlert('error', errorMessage);
        setConnectionStatus('offline');
      } finally {
        elements.loginBtn.disabled = false;
        elements.loginBtn.textContent = 'Connexion';
      }
    });

    elements.logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showAlert('success', 'D√©connexion r√©ussie');
      } catch (error) {
        showAlert('error', 'Erreur lors de la d√©connexion');
      }
    });

    // Bouton pour toggler les tests de connectivit√©
    elements.toggleNetworkTestBtn.addEventListener('click', () => {
      if (networkManager.enableNetworkTesting) {
        networkManager.disableNetworkTesting();
        elements.toggleNetworkTestBtn.textContent = 'üåê R√©activer tests r√©seau';
        elements.toggleNetworkTestBtn.className = 'success';
        showAlert('info', 'Tests de connectivit√© d√©sactiv√©s');
      } else {
        networkManager.enableNetworkTesting();
        elements.toggleNetworkTestBtn.textContent = 'üåê D√©sactiver tests r√©seau';
        elements.toggleNetworkTestBtn.className = 'warning';
        showAlert('info', 'Tests de connectivit√© r√©activ√©s');
      }
    });

    // Bouton pour cr√©er le profil admin manuellement
    elements.createAdminProfileBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      
      elements.createAdminProfileBtn.disabled = true;
      elements.createAdminProfileBtn.textContent = 'Cr√©ation...';
      
      try {
        await createAdminProfile(currentUser);
        showAlert('success', 'Profil administrateur cr√©√© avec succ√®s !');
        
        setTimeout(() => {
          window.location.reload();
        }, 1500);
        
      } catch (error) {
        showAlert('error', 'Erreur lors de la cr√©ation du profil admin');
      } finally {
        elements.createAdminProfileBtn.disabled = false;
        elements.createAdminProfileBtn.textContent = 'üëë Cr√©er mon profil admin';
      }
    });

    // Fonction pour nettoyer les donn√©es corrompues avec retry
    async function cleanupCorruptedData() {
      return networkManager.executeWithRetry(async () => {
        console.log('üßπ D√©marrage du nettoyage des donn√©es...');
        
        const allDocsSnapshot = await getDocs(collection(db, 'users'));
        let fixedCount = 0;
        let deletedCount = 0;
        
        for (const docSnap of allDocsSnapshot.docs) {
          const data = docSnap.data();
          const docId = docSnap.id;
          
          if (!data.uid || data.uid === 'undefined' || data.uid === null) {
            if (data.email) {
              await updateDoc(doc(db, 'users', docId), {
                uid: docId,
                updatedAt: serverTimestamp(),
                fixedBy: 'cleanup_function',
                fixedAt: serverTimestamp()
              });
              fixedCount++;
            } else {
              await updateDoc(doc(db, 'users', docId), {
                deleted: true,
                deletedReason: 'corrupted_data',
                deletedAt: serverTimestamp(),
                deletedBy: 'cleanup_function'
              });
              deletedCount++;
            }
          }
          
          if (data.role && !['admin', 'moderator', 'user', 'vendeuse'].includes(data.role)) {
            await updateDoc(doc(db, 'users', docId), {
              role: 'user',
              originalRole: data.role,
              updatedAt: serverTimestamp()
            });
            fixedCount++;
          }
        }
        
        await setDoc(doc(db, 'admin_logs', `cleanup_${Date.now()}`), {
          action: 'DATA_CLEANUP',
          adminUid: currentUser.uid,
          adminEmail: currentUser.email,
          details: {
            totalDocuments: allDocsSnapshot.docs.length,
            fixedDocuments: fixedCount,
            deletedDocuments: deletedCount
          },
          timestamp: serverTimestamp()
        });
        
        showAlert('success', `Nettoyage termin√©: ${fixedCount} r√©par√©s, ${deletedCount} supprim√©s`);
        
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      });
    }

    // Bouton pour nettoyer les donn√©es
    elements.cleanupDataBtn.addEventListener('click', async () => {
      if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir nettoyer les donn√©es corrompues ?\n\nCela va :\n- R√©parer les UID manquants\n- Normaliser les r√¥les\n- Supprimer les donn√©es invalides')) {
        return;
      }
      
      elements.cleanupDataBtn.disabled = true;
      elements.cleanupDataBtn.textContent = 'Nettoyage...';
      
      try {
        await cleanupCorruptedData();
      } catch (error) {
        console.error('‚ùå Erreur lors du nettoyage:', error);
        showAlert('error', 'Erreur lors du nettoyage des donn√©es');
      } finally {
        elements.cleanupDataBtn.disabled = false;
        elements.cleanupDataBtn.textContent = 'üßπ Nettoyer les donn√©es';
      }
    });

    // Bouton pour modifier la soci√©t√©
    elements.editCompanyBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      
      try {
        const userDoc = await networkManager.executeWithRetry(async () => {
          return await getDoc(doc(db, 'users', currentUser.uid));
        });
        
        const currentCompany = userDoc.exists() ? userDoc.data().company || '' : '';
        
        elements.companyNameInput.value = currentCompany;
        elements.companyModal.classList.remove('hidden');
        elements.companyNameInput.focus();
        
      } catch (error) {
        console.error('Erreur lors du chargement de la soci√©t√©:', error);
        elements.companyNameInput.value = '';
        elements.companyModal.classList.remove('hidden');
      }
    });

    // Gestionnaires de la modale de soci√©t√©
    elements.companyCancel.addEventListener('click', () => {
      elements.companyModal.classList.add('hidden');
    });

    elements.companyConfirm.addEventListener('click', async () => {
      const newCompanyName = elements.companyNameInput.value.trim();
      
      if (!newCompanyName) {
        showAlert('error', 'Veuillez entrer un nom de soci√©t√©');
        return;
      }
      
      elements.companyConfirm.disabled = true;
      elements.companyConfirm.textContent = 'Enregistrement...';
      
      try {
        await networkManager.executeWithRetry(async () => {
          await updateDoc(doc(db, 'users', currentUser.uid), {
            company: newCompanyName,
            companyRole: 'owner',
            updatedAt: serverTimestamp()
          });
          
          const vendeusesQuery = query(
            collection(db, 'users'), 
            where('managedBy', '==', currentUser.uid),
            where('role', '==', 'vendeuse')
          );
          
          const vendeusesSnapshot = await getDocs(vendeusesQuery);
          const updatePromises = vendeusesSnapshot.docs.map(vendeuseDoc => 
            updateDoc(doc(db, 'users', vendeuseDoc.id), {
              company: newCompanyName,
              updatedAt: serverTimestamp()
            })
          );
          
          await Promise.all(updatePromises);
          
          await setDoc(doc(db, 'admin_logs', `company_update_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`), {
            action: 'COMPANY_NAME_UPDATED',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            details: {
              newCompanyName: newCompanyName,
              vendeuseUpdated: vendeusesSnapshot.docs.length
            },
            timestamp: serverTimestamp()
          });
          
          return vendeusesSnapshot.docs.length;
        });
        
        showAlert('success', `Soci√©t√© "${newCompanyName}" mise √† jour avec succ√®s !`);
        elements.companyModal.classList.add('hidden');
        
      } catch (error) {
        console.error('‚ùå Erreur lors de la mise √† jour de la soci√©t√©:', error);
        showAlert('error', 'Erreur lors de la mise √† jour de la soci√©t√©');
      } finally {
        elements.companyConfirm.disabled = false;
        elements.companyConfirm.textContent = 'Enregistrer';
      }
    });

    // Support de la touche Entr√©e dans l'input de soci√©t√©
    elements.companyNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        elements.companyConfirm.click();
      }
    });

    // Gestion des √©tats d'authentification
    onAuthStateChanged(auth, async (user) => {
      if (unsubscribeUsers) {
        unsubscribeUsers();
        unsubscribeUsers = null;
      }
      if (unsubscribeLogs) {
        unsubscribeLogs();
        unsubscribeLogs = null;
      }

      if (!user) {
        showLoggedOutState();
        return;
      }

      currentUser = user;
      isAdmin = user.email === ADMIN_EMAIL;
      
      if (isAdmin) {
        console.log(`‚úÖ Acc√®s administrateur accord√© pour: ${user.email}`);
        
        try {
          const userDoc = await networkManager.executeWithRetry(async () => {
            return await getDoc(doc(db, 'users', user.uid));
          });
          
          if (!userDoc.exists() || userDoc.data().role !== 'admin') {
            console.log("üîß Profil admin non trouv√©, cr√©ation automatique...");
            await createAdminProfile(user);
          }
        } catch (error) {
          console.log("Erreur lors de la v√©rification du profil, cr√©ation automatique...");
          try {
            await createAdminProfile(user);
          } catch (createError) {
            console.error("Erreur lors de la cr√©ation du profil:", createError);
          }
        }
        
        showAdminState();
        await loadAdminData();
      } else {
        showUnauthorizedState();
      }
    });

    function showLoggedOutState() {
      elements.loginForm.classList.remove('hidden');
      elements.userInfo.classList.add('hidden');
      elements.loginPrompt.classList.remove('hidden');
      elements.adminInterface.classList.add('hidden');
      elements.statsCard.classList.add('hidden');
      elements.logsCard.classList.add('hidden');
      elements.statusMessage.innerHTML = '';
      
      setConnectionStatus('offline');
      currentUser = null;
      isAdmin = false;
    }

    function showUnauthorizedState() {
      elements.loginForm.classList.add('hidden');
      elements.userInfo.classList.remove('hidden');
      elements.loginPrompt.classList.add('hidden');
      elements.adminInterface.classList.add('hidden');
      elements.statsCard.classList.add('hidden');
      elements.logsCard.classList.add('hidden');
      
      elements.userEmail.textContent = currentUser.email;
      elements.userAvatar.textContent = getUserInitials(currentUser);
      
      elements.statusMessage.innerHTML = `
        <div class="alert alert-error">
          <strong>‚ö†Ô∏è Acc√®s refus√©</strong><br>
          Droits administrateur requis. Connect√© en tant que: <strong>${currentUser.email}</strong><br>
          <small>Seul ${ADMIN_EMAIL} peut acc√©der √† cette interface.</small>
        </div>
      `;
      
      setConnectionStatus('connected');
    }

    function showAdminState() {
      elements.loginForm.classList.add('hidden');
      elements.userInfo.classList.remove('hidden');
      elements.loginPrompt.classList.add('hidden');
      elements.adminInterface.classList.remove('hidden');
      elements.statsCard.classList.remove('hidden');
      elements.logsCard.classList.remove('hidden');
      
      elements.userEmail.textContent = currentUser.email;
      elements.userAvatar.textContent = getUserInitials(currentUser);
      
      elements.statusMessage.innerHTML = `
        <div class="alert alert-success">
          <strong>‚úÖ Acc√®s administrateur accord√©</strong><br>
          Connect√© en tant qu'administrateur: <strong>${currentUser.email}</strong>
        </div>
      `;
      
      setConnectionStatus('connected');
    }

    // Chargement des donn√©es admin
    async function loadAdminData() {
      try {
        await loadStats();
        listenToUsers();
        listenToLogs();
      } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
        showAlert('error', 'Erreur lors du chargement des donn√©es');
      }
    }

    async function loadStats() {
      try {
        const usersSnapshot = await networkManager.executeWithRetry(async () => {
          return await getDocs(collection(db, 'users'));
        });
        
        const users = usersSnapshot.docs.map(doc => doc.data());
        
        const stats = {
          totalUsers: users.length,
          activeUsers: users.filter(u => !u.disabled).length,
          disabledUsers: users.filter(u => u.disabled).length,
          warnedUsers: users.filter(u => u.paymentWarning && getPaymentWarningStatus(u) === 'active').length,
          adminUsers: users.filter(u => u.role === 'admin').length
        };
        
        updateStatsDisplay(stats);
      } catch (error) {
        console.error('Erreur lors du chargement des statistiques:', error);
        updateStatsDisplay({
          totalUsers: '-',
          activeUsers: '-', 
          disabledUsers: '-',
          warnedUsers: '-',
          adminUsers: '-'
        });
      }
    }

    function updateStatsDisplay(stats) {
      elements.totalUsers.textContent = stats.totalUsers;
      elements.activeUsers.textContent = stats.activeUsers;
      elements.disabledUsers.textContent = stats.disabledUsers;
      elements.warnedUsers.textContent = stats.warnedUsers;
      elements.adminUsers.textContent = stats.adminUsers;
    }

    function updateCompanyFilter() {
      const companies = [...new Set(allUsers.map(user => user.company).filter(Boolean))];
      
      elements.companyFilter.innerHTML = '<option value="">Toutes les soci√©t√©s</option>' +
        companies.map(company => `<option value="${company}">${company}</option>`).join('');
    }

    function listenToUsers() {
      if (unsubscribeUsers) {
        unsubscribeUsers();
      }
      
      try {
        const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
        unsubscribeUsers = onSnapshot(q, 
          (snapshot) => {
            console.log(`üìã Donn√©es re√ßues: ${snapshot.docs.length} utilisateurs`);
            setConnectionStatus('connected');
            lastDataUpdate = Date.now();
            
            allUsers = snapshot.docs
              .map(doc => {
                const data = doc.data();
                return {
                  id: doc.id,
                  uid: data.uid || doc.id,
                  ...data
                };
              })
              .filter(user => {
                return user.uid && 
                       user.uid !== 'undefined' && 
                       user.uid !== null &&
                       user.email;
              });
            
            const stats = {
              totalUsers: allUsers.length,
              activeUsers: allUsers.filter(u => !u.disabled).length,
              disabledUsers: allUsers.filter(u => u.disabled).length,
              warnedUsers: allUsers.filter(u => u.paymentWarning && getPaymentWarningStatus(u) === 'active').length,
              adminUsers: allUsers.filter(u => u.role === 'admin').length
            };
            updateStatsDisplay(stats);
            
            updateCompanyFilter();
            filterAndDisplayUsers();
          },
          (error) => {
            console.error('‚ùå Erreur listener Firestore:', error);
            setConnectionStatus('reconnecting');
            
            setTimeout(() => {
              if (isAdmin && Date.now() - lastDataUpdate > 30000) {
                console.log('üîÑ Tentative de reconnexion...');
                listenToUsers();
              }
            }, 5000);
          }
        );
      } catch (error) {
        console.error('‚ùå Erreur lors de la cr√©ation du listener:', error);
        setConnectionStatus('offline');
      }
    }

    function listenToLogs() {
      if (unsubscribeLogs) {
        unsubscribeLogs();
      }
      
      try {
        const q = query(collection(db, 'admin_logs'), orderBy('timestamp', 'desc'), limit(20));
        unsubscribeLogs = onSnapshot(q, 
          (snapshot) => {
            const logs = snapshot.docs.map(doc => doc.data());
            displayLogs(logs);
          },
          (error) => {
            console.error('Erreur listener logs:', error);
          }
        );
      } catch (error) {
        console.log('Collection admin_logs non disponible');
        elements.logsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">Logs non disponibles</div>';
      }
    }

    function displayLogs(logs) {
      if (logs.length === 0) {
        elements.logsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">Aucune activit√© r√©cente</div>';
        return;
      }

      elements.logsContainer.innerHTML = logs.map(log => `
        <div class="log-entry">
          <strong>${log.action || 'Action inconnue'}</strong>
          ${log.targetUid ? `- Utilisateur: ${log.targetUid}` : ''}
          <div class="log-timestamp">${formatDate(log.timestamp)}</div>
        </div>
      `).join('');
    }

    function filterAndDisplayUsers() {
      let filteredUsers = [...allUsers];
      
      const searchTerm = elements.searchUsers.value.toLowerCase();
      if (searchTerm) {
        filteredUsers = filteredUsers.filter(user => 
          (user.email || '').toLowerCase().includes(searchTerm) ||
          (user.displayName || '').toLowerCase().includes(searchTerm) ||
          (user.company || '').toLowerCase().includes(searchTerm) ||
          user.uid.toLowerCase().includes(searchTerm)
        );
      }
      
      const roleFilter = elements.roleFilter.value;
      if (roleFilter) {
        filteredUsers = filteredUsers.filter(user => (user.role || 'user') === roleFilter);
      }
      
      const statusFilter = elements.statusFilter.value;
      if (statusFilter) {
        if (statusFilter === 'active') {
          filteredUsers = filteredUsers.filter(user => !user.disabled);
        } else if (statusFilter === 'disabled') {
          filteredUsers = filteredUsers.filter(user => user.disabled);
        } else if (statusFilter === 'warned') {
          filteredUsers = filteredUsers.filter(user => 
            user.paymentWarning && getPaymentWarningStatus(user) === 'active'
          );
        }
      }
      
      const companyFilter = elements.companyFilter.value;
      if (companyFilter) {
        filteredUsers = filteredUsers.filter(user => user.company === companyFilter);
      }
      
      displayUsers(filteredUsers);
    }

    function displayUsers(users) {
      console.log(`üë• Affichage de ${users.length} utilisateurs`);
      
      if (users.length === 0) {
        elements.usersTable.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
              Aucun utilisateur trouv√©
            </td>
          </tr>
        `;
        return;
      }

      const userRows = users.map(user => {
        const isCurrentUser = user.uid === currentUser?.uid;
        const paymentWarning = formatPaymentWarning(user);
        const hasActiveWarning = getPaymentWarningStatus(user) === 'active';
        
        return `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="user-avatar" style="width: 24px; height: 24px; font-size: 10px;">
                ${getUserInitials(user)}
              </div>
              <div>
                <div style="font-weight: 500;">${user.displayName || 'Sans nom'}</div>
                ${paymentWarning}
                ${user.autoCreated ? '<span style="color: var(--warning); font-size: 10px;">(Auto)</span>' : ''}
                ${user.isExample ? '<span style="color: var(--muted); font-size: 10px;">(Exemple)</span>' : ''}
              </div>
            </div>
          </td>
          <td>${user.email || '-'}</td>
          <td>${formatCompany(user.company, user.companyRole)}</td>
          <td>${formatRole(user.role || 'user')}</td>
          <td class="${user.disabled ? 'status-disabled' : hasActiveWarning ? 'status-warned' : 'status-active'}">
            ${user.disabled ? 'üîí D√©sactiv√©' : hasActiveWarning ? '‚ö†Ô∏è Avertissement' : '‚úÖ Actif'}
          </td>
          <td>${formatDate(user.createdAt)}</td>
          <td>
            <div class="actions">
              <button onclick="handleToggleUser('${user.uid}', ${user.disabled})" 
                      title="${user.disabled ? 'Activer' : 'D√©sactiver'}"
                      ${isCurrentUser ? 'disabled' : ''}>
                ${user.disabled ? 'üîì' : 'üîí'}
              </button>
              <button onclick="handleSimplePaymentWarning('${user.uid}')"
                      title="‚ö†Ô∏è AVERTISSEMENT DE PAIEMENT"
                      class="payment"
                      ${isCurrentUser ? 'disabled' : ''}>
                üö®
              </button>
              <button onclick="handleChangeRole('${user.uid}', '${user.role || 'user'}')"
                      title="Changer le r√¥le"
                      ${isCurrentUser ? 'disabled' : ''}>
                üë§
              </button>
              ${user.role === 'vendeuse' ? 
                `<button onclick="handleAssignToCompany('${user.uid}')" title="Assigner √† ma soci√©t√©">üè¢</button>` : 
                ''
              }
              <button onclick="handleDeleteUser('${user.uid}')" class="danger"
                      title="Supprimer"
                      ${isCurrentUser ? 'disabled' : ''}>
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `;
      });

      elements.usersTable.innerHTML = userRows.join('');
      console.log('‚úÖ Tableau des utilisateurs mis √† jour');
    }

    // Gestionnaires d'actions s√©curis√©s avec retry
    window.handleToggleUser = (uid, currentDisabled) => {
      if (!uid || uid === 'undefined') {
        showAlert('error', 'Erreur: ID utilisateur invalide');
        return;
      }
      
      const action = currentDisabled ? 'activer' : 'd√©sactiver';
      pendingAction = {
        type: 'toggle',
        uid: uid,
        action: currentDisabled ? 'enable' : 'disable'
      };
      
      elements.modalTitle.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} l'utilisateur`;
      elements.modalMessage.textContent = `√ätes-vous s√ªr de vouloir ${action} cet utilisateur ?`;
      elements.confirmModal.classList.remove('hidden');
    };

    window.handleChangeRole = (uid, currentRole) => {
      if (!uid || uid === 'undefined') {
        showAlert('error', 'Erreur: ID utilisateur invalide');
        return;
      }
      
      const user = allUsers.find(u => u.uid === uid);
      if (!user) {
        showAlert('error', 'Utilisateur non trouv√©');
        return;
      }
      
      pendingAction = {
        type: 'role',
        uid: uid,
        currentRole: currentRole
      };
      
      elements.roleModalUser.textContent = `Utilisateur: ${user.email}`;
      elements.newRoleSelect.value = currentRole;
      elements.roleModal.classList.remove('hidden');
    };

    window.handleDeleteUser = (uid) => {
      if (!uid || uid === 'undefined') {
        showAlert('error', 'Erreur: ID utilisateur invalide');
        return;
      }
      
      pendingAction = {
        type: 'delete',
        uid: uid
      };
      
      elements.modalTitle.textContent = 'Supprimer l\'utilisateur';
      elements.modalMessage.textContent = '‚ö†Ô∏è Cette action est irr√©versible ! √ätes-vous s√ªr de vouloir supprimer cet utilisateur ?';
      elements.confirmModal.classList.remove('hidden');
    };

    window.handleAssignToCompany = async (uid) => {
      if (!uid || uid === 'undefined') {
        showAlert('error', 'Erreur: ID utilisateur invalide');
        return;
      }
      
      if (!currentUser) {
        showAlert('error', 'Erreur: Aucun utilisateur connect√©');
        return;
      }
      
      try {
        await networkManager.executeWithRetry(async () => {
          const adminDoc = await getDoc(doc(db, 'users', currentUser.uid));
          if (!adminDoc.exists()) {
            throw new Error('Profil administrateur non trouv√©');
          }
          
          const adminData = adminDoc.data();
          const companyName = adminData.company || 'Ma Soci√©t√©';
          
          await updateDoc(doc(db, 'users', uid), {
            company: companyName,
            companyRole: 'employee',
            managedBy: currentUser.uid,
            updatedAt: serverTimestamp()
          });
          
          await setDoc(doc(db, 'admin_logs', `assign_company_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`), {
            action: 'USER_ASSIGNED_TO_COMPANY',
            adminUid: currentUser.uid,
            adminEmail: currentUser.email,
            targetUid: uid,
            details: {
              company: companyName,
              assignedRole: 'employee'
            },
            timestamp: serverTimestamp()
          });
          
          return companyName;
        });
        
        showAlert('success', 'Vendeuse assign√©e avec succ√®s');
        
      } catch (error) {
        console.error('‚ùå Erreur lors de l\'assignation:', error);
        showAlert('error', 'Erreur lors de l\'assignation √† la soci√©t√©');
      }
    };

    // Gestionnaires de modales
    elements.modalCancel.addEventListener('click', () => {
      elements.confirmModal.classList.add('hidden');
      pendingAction = null;
    });

    elements.modalConfirm.addEventListener('click', async () => {
      if (!pendingAction) return;
      
      elements.modalConfirm.disabled = true;
      elements.modalConfirm.textContent = 'En cours...';
      
      try {
        await executeAction(pendingAction);
        showAlert('success', 'Action ex√©cut√©e avec succ√®s');
      } catch (error) {
        console.error('Erreur lors de l\'action:', error);
        showAlert('error', error.message || 'Une erreur est survenue');
      } finally {
        elements.modalConfirm.disabled = false;
        elements.modalConfirm.textContent = 'Confirmer';
        elements.confirmModal.classList.add('hidden');
        pendingAction = null;
      }
    });

    elements.roleCancel.addEventListener('click', () => {
      elements.roleModal.classList.add('hidden');
      pendingAction = null;
    });

    elements.roleConfirm.addEventListener('click', () => {
      if (!pendingAction) return;
      
      const newRole = elements.newRoleSelect.value;
      pendingAction.newRole = newRole;
      
      elements.roleModal.classList.add('hidden');
      
      elements.modalTitle.textContent = 'Modifier le r√¥le';
      elements.modalMessage.textContent = `Confirmer le changement de r√¥le vers "${newRole}" ?`;
      elements.confirmModal.classList.remove('hidden');
    });

    async function executeAction(action) {
      return networkManager.executeWithRetry(async () => {
        if (!action.uid || action.uid === 'undefined') {
          throw new Error('UID utilisateur invalide');
        }
        
        const userRef = doc(db, 'users', action.uid);
        
        switch (action.type) {
          case 'toggle':
            const newDisabledState = action.action === 'disable';
            
            await updateDoc(userRef, {
              disabled: newDisabledState,
              updatedAt: serverTimestamp(),
              lastModifiedBy: currentUser.uid
            });
            
            await setDoc(doc(db, 'admin_logs', `toggle_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`), {
              action: newDisabledState ? 'USER_DISABLED' : 'USER_ENABLED',
              adminUid: currentUser.uid,
              adminEmail: currentUser.email,
              targetUid: action.uid,
              timestamp: serverTimestamp(),
              method: 'admin_interface_simple',
              details: {
                previousState: !newDisabledState,
                newState: newDisabledState
              }
            });
            break;
            
          case 'role':
            await updateDoc(userRef, {
              role: action.newRole,
              updatedAt: serverTimestamp(),
              lastModifiedBy: currentUser.uid
            });
            
            await setDoc(doc(db, 'admin_logs', `role_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`), {
              action: 'USER_ROLE_CHANGED',
              adminUid: currentUser.uid,
              adminEmail: currentUser.email,
              targetUid: action.uid,
              details: { 
                previousRole: action.currentRole,
                newRole: action.newRole 
              },
              timestamp: serverTimestamp()
            });
            break;
            
          case 'delete':
            await updateDoc(userRef, {
              deleted: true,
              disabled: true,
              deletedAt: serverTimestamp(),
              deletedBy: currentUser.uid,
              updatedAt: serverTimestamp()
            });
            
            await setDoc(doc(db, 'admin_logs', `delete_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`), {
              action: 'USER_DELETED',
              adminUid: currentUser.uid,
              adminEmail: currentUser.email,
              targetUid: action.uid,
              timestamp: serverTimestamp(),
              method: 'soft_delete'
            });
            break;
            
          default:
            throw new Error(`Action non support√©e: ${action.type}`);
        }
      });
    }

    // Filtres et recherche avec debouncing
    let searchTimeout;
    elements.searchUsers.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(filterAndDisplayUsers, 300);
    });
    
    elements.roleFilter.addEventListener('change', filterAndDisplayUsers);
    elements.statusFilter.addEventListener('change', filterAndDisplayUsers);
    elements.companyFilter.addEventListener('change', filterAndDisplayUsers);
    
    elements.refreshUsers.addEventListener('click', async () => {
      try {
        setConnectionStatus('connecting');
        await loadStats();
        showAlert('success', 'Donn√©es actualis√©es');
        setConnectionStatus('connected');
      } catch (error) {
        showAlert('error', 'Erreur lors de l\'actualisation');
        setConnectionStatus('offline');
      }
    });

    // Fermer les modales en cliquant √† l'ext√©rieur
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.add('hidden');
        pendingAction = null;
      }
    });

    // Gestion des raccourcis clavier
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        elements.confirmModal.classList.add('hidden');
        elements.roleModal.classList.add('hidden');
        elements.companyModal.classList.add('hidden');
        pendingAction = null;
      }
    });

    // Nettoyage lors de la fermeture
    window.addEventListener('beforeunload', () => {
      if (networkManager.connectionCheckInterval) {
        clearInterval(networkManager.connectionCheckInterval);
      }
      if (unsubscribeUsers) unsubscribeUsers();
      if (unsubscribeLogs) unsubscribeLogs();
    });

    // Message de bienvenue dans la console
    console.log(`
üîê Administration Anapharmo - Version Simplifi√©e
=============================================
‚úÖ Interface charg√©e avec succ√®s
üë§ Email administrateur autoris√©: ${ADMIN_EMAIL}
üîß Syst√®me de contournement activ√©
üìä Gestion directe via Firestore
üö® Nouveau bouton d'avertissement de paiement simple (üö®)
üåê Gestion r√©seau optimis√©e avec retry automatique
üîÑ Reconnexion automatique activ√©e

üí∞ AVERTISSEMENT DE PAIEMENT SIMPLE:
- Bouton orange üö® √† c√¥t√© du bouton de d√©verrouillage
- Message standard: "Suspension sous 24h + risque de perte de donn√©es"
- Pas de configuration - envoi direct apr√®s confirmation
- Suspension automatique apr√®s 24h

üöÄ Plus simple et plus direct que l'ancien syst√®me !
    `);

    // Exposer networkManager globalement pour debug
    window.networkManager = networkManager;
  </script>
</body>
</html>