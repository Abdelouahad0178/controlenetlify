<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Administration SaaS - Anapharmo Multi-tenant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2b;
      --line: #203054;
      --brand: #1a2a4a;
      --brand2: #2b406b;
      --ok: #b7ffc3;
      --bad: #ffb4b4;
      --warning: #ffd93d;
      --text: #eaeef7;
      --muted: #8892b0;
      --header-height: 70px;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif; line-height:1.6; overflow-x:hidden; }

    header {
      padding:12px 16px; background:#15223a; display:flex; justify-content:space-between; align-items:center;
      border-bottom:2px solid var(--line); position:sticky; top:0; z-index:100; backdrop-filter:blur(8px);
      min-height:var(--header-height); flex-wrap:wrap; gap:12px;
    }
    h1 { margin:0; font-size:clamp(18px,4vw,24px); font-weight:600; }
    h2 { margin-top:0; color:var(--text); font-size:clamp(16px,3vw,18px); font-weight:600; }

    #auth { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .login-form { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #userInfo { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    #userAvatar { width:32px; height:32px; border-radius:50%; background:var(--brand); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; }

    .card { background:var(--panel); border:1px solid #223355; border-radius:12px; padding:16px; margin:16px; box-shadow:0 4px 12px rgba(0,0,0,.3); transition:transform .2s, box-shadow .2s; }
    .card:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.4); }

    input,button,select,textarea { border-radius:8px; border:1px solid var(--brand2); background:#0e1830; color:#fff; padding:12px 16px; font-size:14px; transition:all .2s; min-height:44px; }
    input:focus,select:focus,textarea:focus { outline:none; border-color:var(--ok); box-shadow:0 0 0 3px rgba(183,255,195,.1); }
    button { background:var(--brand); cursor:pointer; font-weight:500; display:inline-flex; align-items:center; justify-content:center; gap:6px; border:1px solid var(--brand2); }
    button:hover:not(:disabled){ filter:brightness(1.15); transform:translateY(-1px); }
    button:active{ transform:translateY(0); }
    button:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    button.danger{ background:#dc2626; border-color:#dc2626; }
    button.success{ background:#059669; border-color:#059669; }
    button.warning{ background:#f59e0b; border-color:#f59e0b; }
    button.info{ background:#3b82f6; border-color:#3b82f6; }
    button.payment{ background:#ff6600; border-color:#ff6600; }
    .hidden{ display:none !important; }

    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
    .search-bar { flex:1; min-width:200px; }

    .nav-tabs { display:flex; gap:8px; margin-bottom:20px; border-bottom:2px solid var(--line); }
    .nav-tab { padding:12px 20px; background:transparent; border:none; border-bottom:3px solid transparent; color:var(--muted); cursor:pointer; font-weight:500; }
    .nav-tab.active { color:var(--ok); border-bottom-color:var(--ok); background:rgba(183,255,195,.1); }
    .nav-tab:hover:not(.active) { color:var(--text); background:rgba(255,255,255,.05); }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    #usersTableContainer, #logsTableContainer, #invitationsTableContainer, #societesTableContainer { overflow-x:auto; margin:16px 0; border-radius:8px; border:1px solid var(--line); }
    table { width:100%; border-collapse:collapse; min-width:1000px; }
    th,td { border-bottom:1px solid var(--line); padding:12px; text-align:left; font-size:14px; white-space:nowrap; }
    th { background:rgba(26,42,74,.7); font-weight:600; position:sticky; top:0; z-index:10; }
    tr:hover { background:rgba(32,48,84,.3); }

    .status-active{ color:var(--ok); font-weight:500; }
    .status-disabled{ color:var(--bad); font-weight:500; }
    .status-pending{ color:var(--warning); font-weight:500; }
    .status-used{ color:var(--muted); font-weight:500; }
    .status-expired{ color:var(--bad); font-weight:500; }
    .payment-warning-badge{ display:inline-flex; gap:4px; padding:2px 6px; border-radius:10px; background:rgba(245,158,11,.2); border:1px solid #f59e0b; font-size:10px; color:var(--warning); font-weight:700; margin-left:6px; }

    .actions { display:flex; gap:6px; flex-wrap:wrap; }
    .actions button { padding:6px 10px; font-size:12px; min-height:32px; white-space:nowrap; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:20px; }
    .stat-card { background:var(--panel); border:1px solid var(--line); border-radius:8px; padding:16px; text-align:center; }
    .stat-number { font-size:2rem; font-weight:700; color:var(--ok); }
    .stat-label { color:var(--muted); margin-top:4px; }

    .invitation-form { background:rgba(59,130,246,.1); border:1px solid #3b82f6; border-radius:8px; padding:16px; margin-bottom:20px; }
    .form-row { display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    .form-group { display:flex; flex-direction:column; gap:4px; min-width:150px; }
    .form-group label { font-weight:500; color:var(--text); }

    .code-display { font-family:monospace; background:#0e1830; padding:8px 12px; border-radius:4px; border:1px solid var(--brand2); font-weight:700; letter-spacing:2px; cursor:pointer; }
    .code-display:hover { background:#1a2a4a; }

    #alertContainer { position:fixed; top:calc(var(--header-height) + 10px); right:16px; z-index:1000; max-width:calc(100vw - 32px); }
    .alert { padding:12px 16px; border-radius:8px; margin:8px 0; transition:opacity .3s; box-shadow:0 4px 12px rgba(0,0,0,.3); backdrop-filter:blur(8px); }
    .alert-success{ background:rgba(5,150,105,.2); border:1px solid #059669; color:var(--ok); }
    .alert-error{ background:rgba(220,38,38,.2); border:1px solid #dc2626; color:var(--bad); }
    .alert-warning{ background:rgba(255,217,61,.2); border:1px solid #ffd93d; color:var(--warning); }
    .alert-info{ background:rgba(59,130,246,.2); border:1px solid #3b82f6; color:#3b82f6; }

    @media (max-width:1023px) and (min-width:768px){
      .card{ margin:12px; padding:20px; }
      .toolbar{ gap:10px; }
      .search-bar{ min-width:150px; }
      table{ min-width:900px; }
      th,td{ padding:10px 8px; font-size:13px; }
      .actions button{ padding:4px 8px; font-size:11px; }
    }
    @media (max-width:767px){
      header{ padding:8px 12px; flex-direction:column; align-items:stretch; gap:12px; position:relative; --header-height:auto; }
      h1{ text-align:center; font-size:18px; }
      #auth{ justify-content:center; }
      .login-form{ width:100%; justify-content:center; }
      .login-form input{ flex:1; min-width:120px; font-size:16px; }
      #userInfo{ justify-content:center; width:100%; }
      #userEmail{ font-size:14px; text-overflow:ellipsis; overflow:hidden; max-width:150px; }
      .card{ margin:8px; padding:12px; border-radius:10px; }
      .toolbar{ flex-direction:column; align-items:stretch; gap:8px; }
      .search-bar{ width:100%; min-width:auto; font-size:16px; }
      select{ width:100%; font-size:16px; }
      button{ width:100%; padding:14px 16px; font-size:16px; }
      .nav-tabs{ flex-wrap:wrap; }
      .nav-tab{ flex:1; text-align:center; }
      #usersTableContainer,#logsTableContainer,#invitationsTableContainer,#societesTableContainer{ margin:12px -12px; border-left:none; border-right:none; border-radius:0; }
      table{ min-width:800px; }
      th,td{ padding:8px 6px; font-size:12px; }
      .actions{ flex-direction:column; gap:4px; min-width:120px; }
      .actions button{ width:100%; padding:6px 8px; font-size:10px; min-height:28px; }
      .stats-grid{ grid-template-columns:repeat(2,1fr); }
      .form-row{ flex-direction:column; }
      .form-group{ min-width:100%; }
      #alertContainer{ position:fixed; top:10px; left:8px; right:8px; max-width:none; }
      .alert{ padding:10px 12px; font-size:14px; }
    }
    @media (max-width:479px){
      .card{ margin:4px; padding:8px; }
      h2{ font-size:16px; }
      .login-form{ flex-direction:column; gap:8px; }
      .login-form input,.login-form button{ width:100%; }
      table{ min-width:700px; }
      th,td{ padding:6px 4px; font-size:11px; }
      .actions button{ font-size:9px; padding:4px 6px; }
      .stats-grid{ grid-template-columns:1fr; }
    }
    @media (min-width:1200px){
      .card{ margin:24px auto; max-width:1400px; padding:24px; }
      header{ padding:16px 24px; }
      .toolbar{ gap:16px; }
      th,td{ padding:14px 16px; font-size:15px; }
      .actions button{ padding:8px 12px; font-size:13px; }
    }

    @media (prefers-reduced-motion: reduce){ *{ animation-duration:.01ms !important; animation-iteration-count:1 !important; transition-duration:.01ms !important; } }
    button:focus-visible,input:focus-visible,select:focus-visible{ outline:2px solid var(--ok); outline-offset:2px; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-track{ background:var(--bg); }
    ::-webkit-scrollbar-thumb{ background:var(--brand2); border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover{ background:var(--brand); }
  </style>
</head>
<body>
  <header>
    <h1>üè¢ Administration SaaS Anapharmo</h1>
    <div id="auth">
      <form id="loginForm" class="login-form" role="form" aria-label="Formulaire de connexion administrateur">
        <input id="email" type="email" placeholder="admin@email.com" autocomplete="email" aria-label="Adresse email administrateur" required />
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" aria-label="Mot de passe administrateur" required />
        <button type="submit" id="loginBtn" aria-describedby="login-status">Connexion</button>
      </form>
      <div id="userInfo" class="hidden">
        <div id="userAvatar">A</div>
        <span id="userEmail">user@email.com</span>
        <button id="logoutBtn" class="danger">D√©connexion</button>
      </div>
    </div>
  </header>

  <div id="alertContainer" aria-live="polite" aria-label="Zone de notifications"></div>

  <div class="card">
    <div id="adminInterface" class="hidden">
      <!-- Statistiques g√©n√©rales -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="statsUsers">0</div>
          <div class="stat-label">üë• Utilisateurs totaux</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statsSocietes">0</div>
          <div class="stat-label">üè¢ Soci√©t√©s actives</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statsInvitations">0</div>
          <div class="stat-label">üéØ Invitations en cours</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statsActiveUsers">0</div>
          <div class="stat-label">‚úÖ Utilisateurs actifs</div>
        </div>
      </div>

      <!-- Navigation par onglets -->
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('users', this)">üë• Utilisateurs</button>
        <button class="nav-tab" onclick="switchTab('societes', this)">üè¢ Soci√©t√©s</button>
        <button class="nav-tab" onclick="switchTab('invitations', this)">üéØ Invitations</button>
        <button class="nav-tab" onclick="switchTab('logs', this)">üìù Activit√©s</button>
      </div>

      <!-- ONGLET UTILISATEURS -->
      <div id="tab-users" class="tab-content active">
        <h2>üë• Gestion des utilisateurs</h2>
        <div class="toolbar" role="toolbar" aria-label="Outils de filtrage des utilisateurs">
          <input id="searchUsers" class="search-bar" placeholder="üîç Rechercher..." autocomplete="off" aria-label="Rechercher des utilisateurs par nom ou email" type="search" />
          <select id="roleFilter" aria-label="Filtrer par r√¥le">
            <option value="">Tous les r√¥les</option>
            <option value="docteur">Pharmacien</option>
            <option value="vendeuse">Vendeuse</option>
          </select>
          <select id="companyFilter" aria-label="Filtrer par soci√©t√©">
            <option value="">Toutes les soci√©t√©s</option>
          </select>
          <select id="statusFilter" aria-label="Filtrer par statut">
            <option value="">Tous les statuts</option>
            <option value="active">Actifs</option>
            <option value="disabled">D√©sactiv√©s</option>
            <option value="locked">Verrouill√©s</option>
            <option value="warned">Avertis paiement</option>
          </select>
          <button id="refreshUsers" aria-label="Actualiser la liste des utilisateurs">üîÑ Actualiser</button>
        </div>

        <div id="usersTableContainer" role="region" aria-label="Tableau des utilisateurs" tabindex="0">
          <table role="table" aria-label="Liste des utilisateurs avec leurs informations et actions">
            <thead>
              <tr role="row">
                <th scope="col">üë§ Utilisateur</th>
                <th scope="col">üìß Email</th>
                <th scope="col">üè∑Ô∏è R√¥le</th>
                <th scope="col">üè¢ Soci√©t√©</th>
                <th scope="col">üìä Statut</th>
                <th scope="col">üîí Verrouillage</th>
                <th scope="col">üí∞ Paiement</th>
                <th scope="col">üëë Propri√©taire</th>
                <th scope="col">üìÖ Cr√©√© le</th>
                <th scope="col">üîß Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
        </div>
      </div>

      <!-- ONGLET SOCI√âT√âS -->
      <div id="tab-societes" class="tab-content">
        <h2>üè¢ Gestion des soci√©t√©s</h2>
        <div class="toolbar">
          <input id="searchSocietes" class="search-bar" placeholder="üîç Rechercher soci√©t√©s..." type="search" />
          <button id="refreshSocietes">üîÑ Actualiser</button>
        </div>

        <div id="societesTableContainer" role="region" aria-label="Tableau des soci√©t√©s" tabindex="0">
          <table>
            <thead>
              <tr>
                <th>üè¢ Nom</th>
                <th>üìç Adresse</th>
                <th>üìû T√©l√©phone</th>
                <th>üëë Propri√©taire</th>
                <th>üë• Utilisateurs</th>
                <th>üìÖ Cr√©√©e le</th>
                <th>üîß Actions</th>
              </tr>
            </thead>
            <tbody id="societesTable"></tbody>
          </table>
        </div>
      </div>

      <!-- ONGLET INVITATIONS -->
      <div id="tab-invitations" class="tab-content">
        <h2>üéØ Gestion des invitations</h2>
        
        <!-- Formulaire cr√©ation d'invitation -->
        <div class="invitation-form">
          <h3>‚ûï Cr√©er une invitation d'urgence</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Email de la personne</label>
              <input id="inviteEmail" type="email" placeholder="user@example.com" />
            </div>
            <div class="form-group">
              <label>R√¥le</label>
              <select id="inviteRole">
                <option value="vendeuse">Vendeuse</option>
                <option value="docteur">Docteur</option>
              </select>
            </div>
            <div class="form-group">
              <label>Soci√©t√©</label>
              <select id="inviteSociete">
                <option value="">S√©lectionner...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Note (optionnel)</label>
              <input id="inviteNote" placeholder="Invitation d'urgence" />
            </div>
            <button id="createInvitation" class="success">üéØ Cr√©er invitation</button>
          </div>
        </div>

        <div class="toolbar">
          <input id="searchInvitations" class="search-bar" placeholder="üîç Rechercher invitations..." type="search" />
          <select id="invitationStatusFilter">
            <option value="">Tous les statuts</option>
            <option value="pending">En attente</option>
            <option value="used">Utilis√©e</option>
            <option value="expired">Expir√©e</option>
            <option value="cancelled">Annul√©e</option>
          </select>
          <button id="refreshInvitations">üîÑ Actualiser</button>
        </div>

        <div id="invitationsTableContainer" role="region" aria-label="Tableau des invitations" tabindex="0">
          <table>
            <thead>
              <tr>
                <th>üéØ Code</th>
                <th>üìß Email invit√©</th>
                <th>üè∑Ô∏è R√¥le</th>
                <th>üè¢ Soci√©t√©</th>
                <th>üìä Statut</th>
                <th>üë®‚Äçüíº Cr√©√© par</th>
                <th>üìÖ Cr√©√©e le</th>
                <th>‚è∞ Expire le</th>
                <th>üîß Actions</th>
              </tr>
            </thead>
            <tbody id="invitationsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- ONGLET ACTIVIT√âS -->
      <div id="tab-logs" class="tab-content">
        <h2>üìù Activit√©s r√©centes</h2>
        <div class="toolbar" role="toolbar" aria-label="Filtres des activit√©s">
          <input id="logsSearch" class="search-bar" placeholder="üîç Rechercher (email, d√©tails‚Ä¶)" autocomplete="off" aria-label="Rechercher dans les activit√©s" type="search" />
          <select id="logsActionFilter" aria-label="Filtrer par type d'action">
            <option value="">Toutes les actions</option>
            <option value="USER_ACTIVATED">‚úÖ Activation utilisateur</option>
            <option value="USER_DEACTIVATED">üö´ D√©sactivation utilisateur</option>
            <option value="USER_LOCKED">üîí Verrouillage utilisateur</option>
            <option value="USER_UNLOCKED">üîì D√©verrouillage utilisateur</option>
            <option value="VENDEUSE_LOCKED_WITH_PHARMACIEN">üîí Vendeuse verrouill√©e (cascade)</option>
            <option value="VENDEUSE_UNLOCKED_BY_PHARMACIEN">üîì Vendeuse d√©verrouill√©e (cascade)</option>
            <option value="PAYMENT_MARKED_PAID">‚úÖ Paiement marqu√© pay√©</option>
            <option value="PAYMENT_MARKED_UNPAID">‚ùå Paiement marqu√© non pay√©</option>
            <option value="PAYMENT_WARNING_SENT">üí∞ Avertissement paiement envoy√©</option>
            <option value="PAYMENT_WARNING_DISABLED">üí∏ Avertissement paiement d√©sactiv√©</option>
            <option value="INVITATION_CREATED">üéØ Invitation cr√©√©e</option>
            <option value="INVITATION_USED">‚úÖ Invitation utilis√©e</option>
            <option value="INVITATION_CANCELLED">‚ùå Invitation annul√©e</option>
            <option value="SOCIETE_CREATED">üè¢ Soci√©t√© cr√©√©e</option>
            <option value="USER_ROLE_CHANGED">üîÑ R√¥le modifi√©</option>
          </select>
          <button id="refreshLogs" aria-label="Actualiser les activit√©s">üîÑ Actualiser</button>
        </div>

        <div id="logsTableContainer" role="region" aria-label="Journal d'activit√©s" tabindex="0">
          <table role="table" aria-label="Liste des activit√©s r√©centes">
            <thead>
              <tr>
                <th scope="col">‚è±Ô∏è Quand</th>
                <th scope="col">üß© Action</th>
                <th scope="col">üë§ Admin</th>
                <th scope="col">üéØ Cible</th>
                <th scope="col">üè¢ Soci√©t√©</th>
                <th scope="col">üìÑ D√©tails</th>
              </tr>
            </thead>
            <tbody id="logsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="loginPrompt" class="alert alert-info" role="status" aria-live="polite">
      üîí <strong>Connexion requise</strong> ‚Äî Connectez-vous avec un compte administrateur pour acc√©der au panneau SaaS.
    </div>
  </div>

  <div id="login-status" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc,
      serverTimestamp, addDoc, deleteField, writeBatch, limit, where, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBHQSPXwED7W-FQMMs1D-OZcjW-5AP8A-w",
      authDomain: "anapharmo.firebaseapp.com",
      projectId: "anapharmo",
      storageBucket: "anapharmo.firebasestorage.app",
      messagingSenderId: "1097322827362",
      appId: "1:1097322827362:web:fd19a67d9af135dcbf4b3b",
      measurementId: "G-JX6HCRX075"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Email administrateur
    const ADMIN_EMAIL = "echchaaba0178@gmail.com";

    // √âl√©ments DOM
    const el = {
      loginForm: document.getElementById('loginForm'),
      loginBtn: document.getElementById('loginBtn'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      userInfo: document.getElementById('userInfo'),
      userEmail: document.getElementById('userEmail'),
      userAvatar: document.getElementById('userAvatar'),
      logoutBtn: document.getElementById('logoutBtn'),
      adminInterface: document.getElementById('adminInterface'),
      loginPrompt: document.getElementById('loginPrompt'),
      alertContainer: document.getElementById('alertContainer'),
      
      // Stats
      statsUsers: document.getElementById('statsUsers'),
      statsSocietes: document.getElementById('statsSocietes'),
      statsInvitations: document.getElementById('statsInvitations'),
      statsActiveUsers: document.getElementById('statsActiveUsers'),
      
      // Utilisateurs
      usersTable: document.getElementById('usersTable'),
      searchUsers: document.getElementById('searchUsers'),
      roleFilter: document.getElementById('roleFilter'),
      companyFilter: document.getElementById('companyFilter'),
      statusFilter: document.getElementById('statusFilter'),
      
      // Soci√©t√©s
      societesTable: document.getElementById('societesTable'),
      searchSocietes: document.getElementById('searchSocietes'),
      
      // Invitations
      invitationsTable: document.getElementById('invitationsTable'),
      searchInvitations: document.getElementById('searchInvitations'),
      invitationStatusFilter: document.getElementById('invitationStatusFilter'),
      inviteEmail: document.getElementById('inviteEmail'),
      inviteRole: document.getElementById('inviteRole'),
      inviteSociete: document.getElementById('inviteSociete'),
      inviteNote: document.getElementById('inviteNote'),
      createInvitation: document.getElementById('createInvitation'),
      
      // Activit√©s
      logsTable: document.getElementById('logsTable'),
      logsSearch: document.getElementById('logsSearch'),
      logsActionFilter: document.getElementById('logsActionFilter'),
    };

    // Variables globales
    let currentUser = null;
    let isAdmin = false;
    let allUsers = [];
    let allSocietes = [];
    let allInvitations = [];
    let allLogs = [];
    let unsubUsers = null;
    let unsubSocietes = null;
    let unsubInvitations = null;
    let unsubLogs = null;

    // Utilitaires
    const showAlert = (type, message, duration = 4000) => {
      const a = document.createElement('div');
      a.className = `alert alert-${type}`;
      a.setAttribute('role', type === 'error' ? 'alert' : 'status');
      a.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
      a.setAttribute('aria-atomic', 'true');
      a.innerHTML = `<strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${message}`;
      el.alertContainer.appendChild(a);
      setTimeout(() => { a.style.opacity = '0'; setTimeout(() => { if (a.parentNode) a.remove(); }, 300); }, Math.max(600, duration - 300));
    };

    const extractUsernameFromEmail = (email) => {
      if (!email || typeof email !== 'string') return 'Sans nom';
      const beforeAt = email.split('@')[0];
      const withoutNumbers = beforeAt.replace(/[0-9]/g, '');
      const cleaned = withoutNumbers.replace(/[._-]/g,' ').trim().split(' ').filter(Boolean)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
      return cleaned || 'Utilisateur';
    };

    const formatDate = (ts) => {
      if (!ts) return '-';
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    };

    const formatRelative = (ts) => {
      if (!ts) return '-';
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      const diff = Date.now() - d.getTime();
      const s = Math.round(diff / 1000);
      if (s < 60) return `il y a ${s}s`;
      const m = Math.round(s/60);
      if (m < 60) return `il y a ${m} min`;
      const h = Math.round(m/60);
      if (h < 24) return `il y a ${h} h`;
      const j = Math.round(h/24);
      return `il y a ${j} j`;
    };

    const formatRole = (role) => {
      const map = { docteur:'Pharmacien', user:'Pharmacien', admin:'Pharmacien', pharmacien:'Pharmacien', vendeuse:'Vendeuse' };
      return map[role] || 'Pharmacien';
    };

    const getSocieteName = (societeId) => {
      const s = allSocietes.find(x => x.id === societeId);
      // Affiche le NOM si pr√©sent, sinon l'ID comme fallback
      return s?.name || s?.nom || societeId || 'Soci√©t√© inconnue';
    };

    const generateInvitationCode = () => {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    };

    const copyToClipboard = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        showAlert('success', 'Code copi√© dans le presse-papier !');
      } catch (err) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showAlert('success', 'Code copi√© !');
      }
    };
    window.copyToClipboard = copyToClipboard;

    // --- MISE √Ä JOUR DES STATISTIQUES (corrige "updateStats is not defined") ---
    const updateStats = () => {
      const activeUsers = allUsers.filter(u => u.active !== false).length;

      // Invitations encore valides ET au statut "pending"
      const pendingInvitations = allInvitations.filter(i => {
        const status = i?.status || 'pending';
        const raw = i?.expiresAt;
        const exp = raw?.toDate ? raw.toDate() : (raw ? new Date(raw) : null);
        const notExpired = !exp || exp > new Date();
        return status === 'pending' && notExpired;
      }).length;

      el.statsUsers.textContent = allUsers.length;
      el.statsSocietes.textContent = allSocietes.length; // ‚Üê bas√© sur la collection 'societe'
      el.statsInvitations.textContent = pendingInvitations;
      el.statsActiveUsers.textContent = activeUsers;
    };

    // Gestion des onglets (√©vite d'utiliser event implicite)
    window.switchTab = (tabName, elBtn) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      const targetTab = document.getElementById(`tab-${tabName}`);
      if (targetTab) targetTab.classList.add('active');
      if (elBtn) elBtn.classList.add('active');
    };

    // MISE √Ä JOUR DES FILTRES
    const updateFilters = () => {
      const societes = [...new Set(allUsers.map(u => u.societeId).filter(Boolean))];
      el.companyFilter.innerHTML = '<option value="">Toutes les soci√©t√©s</option>';
      societes.forEach(sid => {
        const name = getSocieteName(sid);
        const opt = document.createElement('option');
        opt.value = sid;
        opt.textContent = name;
        el.companyFilter.appendChild(opt);
      });
    };

    const updateSocieteOptions = () => {
      el.inviteSociete.innerHTML = '<option value="">S√©lectionner...</option>';
      allSocietes.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name || s.nom || s.id;
        el.inviteSociete.appendChild(opt);
      });
    };

    // RENDU DES TABLEAUX
    const renderUsers = () => {
      const term = (el.searchUsers.value || '').toLowerCase();
      const roleF = el.roleFilter.value;
      const companyF = el.companyFilter.value;
      const statusF = el.statusFilter.value;

      const filtered = allUsers.filter(u => {
        const userName = extractUsernameFromEmail(u.email).toLowerCase();
        const email = (u.email || '').toLowerCase();
        const societeName = getSocieteName(u.societeId).toLowerCase();
        const searchOK = !term || email.includes(term) || userName.includes(term) || societeName.includes(term);

        let roleMatch = true;
        if (roleF === 'docteur') roleMatch = ['docteur','user','admin','pharmacien'].includes(u.role);
        else if (roleF === 'vendeuse') roleMatch = u.role === 'vendeuse';
        else if (roleF) roleMatch = u.role === roleF;

        const companyMatch = !companyF || (u.societeId === companyF);
        
        const isActive = u.active !== false;
        const isLocked = u.locked === true;
        const warned = !!(u.paymentWarning && u.paymentWarning.status === 'active');
        
        const statusMatch = !statusF || 
          (statusF === 'active' && isActive && !isLocked) || 
          (statusF === 'disabled' && !isActive) ||
          (statusF === 'locked' && isLocked) ||
          (statusF === 'warned' && warned);

        return searchOK && roleMatch && companyMatch && statusMatch;
      });

      if (filtered.length === 0) {
        el.usersTable.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:32px;color:var(--muted);font-style:italic;">Aucun utilisateur trouv√©</td></tr>`;
        return;
      }

      let html = '';
      filtered.forEach(u => {
        const isActive = u.active !== false;
        const isLocked = u.locked === true;
        const userName = extractUsernameFromEmail(u.email);
        const societeName = getSocieteName(u.societeId);
        const isOwner = u.isCompanyOwner ? 'üëë' : '';
        
        const isPaid = !!(u.isPaid || u.paid || u.paiement);
        const warned = !!(u.paymentWarning && u.paymentWarning.status === 'active');
        const warnedBadge = warned ? `<span class="payment-warning-badge">‚ö†Ô∏è Averti</span>` : '';

        html += `
          <tr>
            <td><strong>${userName}</strong>${warnedBadge}</td>
            <td>${u.email || '-'}</td>
            <td>${formatRole(u.role)}</td>
            <td>${societeName}</td>
            <td><span class="${isActive ? 'status-active' : 'status-disabled'}">${isActive ? '‚úÖ Actif' : 'üö´ D√©sactiv√©'}</span></td>
            <td><span class="${isLocked ? 'status-disabled' : 'status-active'}">${isLocked ? 'üîí Verrouill√©' : 'üîì Libre'}</span></td>
            <td>
              <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
                <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="togglePayment('${u.uid}', this.checked)" style="transform:scale(1.3);cursor:pointer;" id="pay-${u.uid}" />
                <label for="pay-${u.uid}" style="font-size:12px;color:${isPaid ? 'var(--ok)' : 'var(--muted)'};cursor:pointer;user-select:none;">${isPaid ? '‚úÖ Pay√©' : '‚ùå Non pay√©'}</label>
              </div>
            </td>
            <td>${isOwner}</td>
            <td>${formatDate(u.createdAt)}</td>
            <td class="actions">
              <button class="${isActive ? 'danger' : 'success'}" onclick="toggleUserStatus('${u.uid}')">${isActive ? 'üö´ D√©sactiver' : '‚úÖ Activer'}</button>
              <button class="${isLocked ? 'success' : 'warning'}" onclick="toggleLock('${u.uid}')">${isLocked ? 'üîì D√©verrouiller' : 'üîí Verrouiller'}</button>
              <button class="${warned ? 'payment' : 'warning'}" onclick="togglePaymentWarning('${u.uid}')">${warned ? 'üí∏ Averti ON' : 'üí∞ Averti OFF'}</button>
            </td>
          </tr>`;
      });
      el.usersTable.innerHTML = html;
    };

    const renderSocietes = () => {
      const term = (el.searchSocietes.value || '').toLowerCase();
      
      const filtered = allSocietes.filter(s => {
        const name = (s.name || s.nom || '').toLowerCase();
        const address = (s.address || s.adresse || '').toLowerCase();
        const owner = (s.ownerEmail || '').toLowerCase();
        return !term || name.includes(term) || address.includes(term) || owner.includes(term);
      });

      if (filtered.length === 0) {
        el.societesTable.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--muted);font-style:italic;">Aucune soci√©t√© trouv√©e</td></tr>`;
        return;
      }

      let html = '';
      filtered.forEach(s => {
        const userCount = allUsers.filter(u => u.societeId === s.id).length;
        html += `
          <tr>
            <td><strong>${s.name || s.nom || s.id}</strong></td>
            <td>${s.address || s.adresse || '-'}</td>
            <td>${s.phone || s.telephone || '-'}</td>
            <td>${s.ownerEmail || '-'}</td>
            <td>${userCount} utilisateur${userCount > 1 ? 's' : ''}</td>
            <td>${formatDate(s.createdAt)}</td>
            <td class="actions">
              <button class="info" onclick="viewSocieteDetails('${s.id}')">üëÅÔ∏è Voir</button>
            </td>
          </tr>`;
      });
      el.societesTable.innerHTML = html;
    };

    const renderInvitations = () => {
      const term = (el.searchInvitations.value || '').toLowerCase();
      const statusF = el.invitationStatusFilter.value;

      const filtered = allInvitations.filter(i => {
        const email = (i.emailInvite || '').toLowerCase();
        const code = (i.code || '').toLowerCase();
        const society = getSocieteName(i.societeId).toLowerCase();
        const searchOK = !term || email.includes(term) || code.includes(term) || society.includes(term);

        let realStatus = i.status || 'pending';
        if (realStatus === 'pending' && i.expiresAt) {
          const expiry = i.expiresAt?.toDate?.() || new Date(i.expiresAt);
          if (expiry < new Date()) realStatus = 'expired';
        }

        const statusMatch = !statusF || realStatus === statusF;
        return searchOK && statusMatch;
      });

      if (filtered.length === 0) {
        el.invitationsTable.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--muted);font-style:italic;">Aucune invitation trouv√©e</td></tr>`;
        return;
      }

      let html = '';
      filtered.forEach(i => {
        const expiry = i.expiresAt?.toDate?.() || new Date(i.expiresAt);
        const isExpired = expiry < new Date();
        let status = i.status || 'pending';
        if (status === 'pending' && isExpired) status = 'expired';

        const statusClass = {
          'pending': 'status-pending',
          'used': 'status-used',
          'expired': 'status-expired',
          'cancelled': 'status-disabled'
        }[status] || 'status-pending';

        const statusText = {
          'pending': '‚è≥ En attente',
          'used': '‚úÖ Utilis√©e',
          'expired': '‚è∞ Expir√©e',
          'cancelled': '‚ùå Annul√©e'
        }[status] || status;

        html += `
          <tr>
            <td>
              <span class="code-display" onclick="copyToClipboard('${i.code}')" title="Cliquer pour copier">
                ${i.code}
              </span>
            </td>
            <td>${i.emailInvite || '-'}</td>
            <td>${formatRole(i.roleInvite)}</td>
            <td>${getSocieteName(i.societeId)}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${i.createdBy || '-'}</td>
            <td>${formatDate(i.createdAt)}</td>
            <td>${formatDate(i.expiresAt)}</td>
            <td class="actions">
              ${status === 'pending' ? `<button class="danger" onclick="cancelInvitation('${i.id}')">‚ùå Annuler</button>` : ''}
              ${(status === 'expired' || status === 'cancelled') ? `<button class="warning" onclick="renewInvitation('${i.id}')">üîÑ Renouveler</button>` : ''}
              <button class="danger" onclick="deleteInvitation('${i.id}')">üóëÔ∏è Supprimer</button>
            </td>
          </tr>`;
      });
      el.invitationsTable.innerHTML = html;
    };

    const renderLogs = () => {
      const term = (el.logsSearch.value || '').toLowerCase();
      const actionF = el.logsActionFilter.value;

      const filtered = allLogs.filter(l => {
        const actionOk = !actionF || l.action === actionF;
        const text = [
          l.action || '',
          l.adminEmail || '',
          l.targetEmail || '',
          l.details || '',
        ].join(' ').toLowerCase();
        const searchOk = !term || text.includes(term);
        return actionOk && searchOk;
      });

      if (filtered.length === 0) {
        el.logsTable.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:32px;color:var(--muted);font-style:italic;">Aucune activit√© trouv√©e</td></tr>`;
        return;
      }

      const ACTION_LABELS = {
        'USER_ACTIVATED': '‚úÖ Activation utilisateur',
        'USER_DEACTIVATED': 'üö´ D√©sactivation utilisateur',
        'USER_LOCKED': 'üîí Verrouillage utilisateur',
        'USER_UNLOCKED': 'üîì D√©verrouillage utilisateur',
        'VENDEUSE_LOCKED_WITH_PHARMACIEN': 'üîí Vendeuse verrouill√©e (cascade)',
        'VENDEUSE_UNLOCKED_BY_PHARMACIEN': 'üîì Vendeuse d√©verrouill√©e (cascade)',
        'PAYMENT_MARKED_PAID': '‚úÖ Paiement marqu√© pay√©',
        'PAYMENT_MARKED_UNPAID': '‚ùå Paiement marqu√© non pay√©',
        'PAYMENT_WARNING_SENT': 'üí∞ Avertissement de paiement envoy√©',
        'PAYMENT_WARNING_DISABLED': 'üí∏ Avertissement de paiement d√©sactiv√©',
        'INVITATION_CREATED': 'üéØ Invitation cr√©√©e',
        'INVITATION_USED': '‚úÖ Invitation utilis√©e',
        'INVITATION_CANCELLED': '‚ùå Invitation annul√©e',
        'SOCIETE_CREATED': 'üè¢ Soci√©t√© cr√©√©e',
        'USER_ROLE_CHANGED': 'üîÑ R√¥le modifi√©',
      };

      let html = '';
      filtered.forEach(log => {
        const actionLabel = ACTION_LABELS[log.action] || log.action || '‚Äî';
        const when = formatRelative(log.timestamp);
        const targetUser = allUsers.find(u => u.uid === log.targetUid);
        const society = targetUser ? getSocieteName(targetUser.societeId) : '‚Äî';

        html += `
          <tr>
            <td title="${formatDate(log.timestamp)}">${when}</td>
            <td>${actionLabel}</td>
            <td>${log.adminEmail || '‚Äî'}</td>
            <td>${log.targetEmail || log.targetUid || '‚Äî'}</td>
            <td>${society}</td>
            <td>${log.details || '‚Äî'}</td>
          </tr>`;
      });
      el.logsTable.innerHTML = html;
    };

    // LISTENERS FIRESTORE
    const listenUsers = () => {
      if (unsubUsers) unsubUsers();
      const qUsers = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
      unsubUsers = onSnapshot(qUsers, (snap) => {
        allUsers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
        renderUsers();
        updateStats();
        updateFilters();
      }, (err) => {
        console.error('Erreur users:', err);
        showAlert('error', 'Erreur de chargement des utilisateurs');
      });
    };

    // ‚úÖ IMPORTANT : collection 'societe' (singulier)
    const listenSocietes = () => {
      if (unsubSocietes) unsubSocietes();
      const qSoc = query(collection(db, 'societe'), orderBy('createdAt', 'desc'));
      unsubSocietes = onSnapshot(qSoc, (snap) => {
        allSocietes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSocietes();
        updateStats();
        updateSocieteOptions();
      }, (err) => {
        console.warn('Erreur societe:', err);
      });
    };

    const listenInvitations = () => {
      if (unsubInvitations) unsubInvitations();
      const qInv = query(collection(db, 'invitations'), orderBy('createdAt', 'desc'));
      unsubInvitations = onSnapshot(qInv, (snap) => {
        allInvitations = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderInvitations();
        updateStats();
      }, (err) => {
        console.warn('Erreur invitations:', err);
      });
    };

    const listenLogs = () => {
      if (unsubLogs) unsubLogs();
      const qLogs = query(collection(db, 'admin_logs'), orderBy('timestamp', 'desc'), limit(100));
      unsubLogs = onSnapshot(qLogs, (snap) => {
        allLogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderLogs();
      }, (err) => {
        console.warn('Erreur logs:', err);
      });
    };

    // ACTIONS ADMINISTRATIVES (expos√©es sur window)
    window.toggleUserStatus = async (uid) => {
      const user = allUsers.find(u => u.uid === uid);
      if (!user) return showAlert('error', 'Utilisateur introuvable');

      const isActive = user.active !== false;
      const action = isActive ? 'd√©sactiver' : 'activer';
      
      if (!confirm(`Confirmer la ${action === 'd√©sactiver' ? 'd√©sactivation' : 'r√©activation'} de ${user.email} ?`)) return;

      try {
        await updateDoc(doc(db, 'users', uid), {
          active: !isActive,
          modifiedAt: serverTimestamp(),
          modifiedBy: currentUser?.email || 'admin'
        });

        await addDoc(collection(db, 'admin_logs'), {
          action: isActive ? 'USER_DEACTIVATED' : 'USER_ACTIVATED',
          adminUid: currentUser?.uid,
          adminEmail: currentUser?.email,
          targetUid: uid,
          targetEmail: user.email,
          details: `Utilisateur ${action}√© par l'administrateur`,
          timestamp: serverTimestamp()
        });

        showAlert('success', `Utilisateur ${action}√© avec succ√®s`);
      } catch (error) {
        console.error('Erreur toggleUserStatus:', error);
        showAlert('error', `Erreur: ${error.message}`);
      }
    };

    window.toggleLock = async (uid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');

      const isLocked = u.locked === true;
      const isPharmacien = ['docteur','pharmacien','user','admin'].includes(u.role);

      try {
        if (!isLocked) {
          // ----- VERROUILLER -----
          const title = prompt("Titre du popup (utilisateur)", "üîí Compte verrouill√©") || "üîí Compte verrouill√©";
          const message = prompt("Message du popup", "Votre compte a √©t√© verrouill√© par l'administrateur. Contactez le support.") || "Votre compte a √©t√© verrouill√© par l'administrateur. Contactez le support.";
          const details = prompt("D√©tails (facultatif)", "Raison: s√©curit√© / usage.") || "Raison: s√©curit√© / usage.";
          const hours = parseInt(prompt("Dur√©e du popup (heures)", "24"), 10) || 24;
          const expiryISO = new Date(Date.now() + hours * 3600 * 1000).toISOString();

          if (!confirm(`Confirmer VERROUILLAGE de ${u.email || 'cet utilisateur'} ?`)) return;

          await updateDoc(doc(db, 'users', uid), {
            locked: true,
            lockedAt: serverTimestamp(), 
            lockedBy: currentUser?.email || 'admin',
            adminPopup: { 
              status:'active', 
              type:'lockNotice', 
              title, 
              message, 
              details, 
              issuedAt:serverTimestamp(), 
              expiryDate:expiryISO, 
              issuedBy: currentUser?.email || 'admin' 
            }
          });

          await addDoc(collection(db, 'admin_logs'), {
            action: 'USER_LOCKED', 
            adminUid: currentUser?.uid || null, 
            adminEmail: currentUser?.email || null,
            targetUid: uid, 
            targetEmail: u.email || null,
            details: `Compte verrouill√© + popup admin (${hours}h).`, 
            timestamp: serverTimestamp()
          });

          showAlert('success', `Utilisateur ${u.email || ''} verrouill√© avec succ√®s.`);

          // Verrouiller les vendeuses si c'est un pharmacien
          if (isPharmacien) {
            const vendeuses = allUsers.filter(v => v.role === 'vendeuse' && v.societeId === u.societeId);
            if (vendeuses.length > 0) {
              const batch = writeBatch(db);
              for (const v of vendeuses) {
                batch.update(doc(db,'users',v.uid), {
                  locked: true, 
                  lockedAt: serverTimestamp(), 
                  lockedBy: currentUser?.email || 'admin',
                  adminPopup: { 
                    status:'active', 
                    type:'lockNotice', 
                    title:'üîí Compte verrouill√©', 
                    message:'Votre compte a √©t√© verrouill√© car le pharmacien de votre soci√©t√© est verrouill√©.', 
                    details:`Pharmacien: ${u.email || 'inconnu'}.`, 
                    issuedAt: serverTimestamp(), 
                    expiryDate: expiryISO, 
                    issuedBy: currentUser?.email || 'admin' 
                  }
                });
              }
              await batch.commit();
              
              for (const v of vendeuses) {
                await addDoc(collection(db,'admin_logs'), {
                  action:'VENDEUSE_LOCKED_WITH_PHARMACIEN', 
                  adminUid: currentUser?.uid || null, 
                  adminEmail: currentUser?.email || null,
                  targetUid: v.uid, 
                  targetEmail: v.email || null,
                  details: `Vendeuse verrouill√©e automatiquement car le pharmacien ${u.email || ''} a √©t√© verrouill√©.`, 
                  timestamp: serverTimestamp()
                });
              }
              showAlert('warning', `${vendeuses.length} vendeuse(s) de la soci√©t√© ont √©t√© verrouill√©es automatiquement.`);
            }
          }
        } else {
          // ----- D√âVERROUILLER -----
          const hours = parseInt(prompt("Dur√©e du popup d'info (heures)", "12"), 10) || 12;
          const expiryISO = new Date(Date.now() + hours * 3600 * 1000).toISOString();
          if (!confirm(`D√©verrouiller ${u.email || 'cet utilisateur'} ?`)) return;

          await updateDoc(doc(db,'users',uid), {
            locked: false, 
            lockedAt: deleteField(), 
            lockedBy: deleteField(),
            adminPopup: { 
              status:'active', 
              type:'unlockNotice', 
              title:'‚úÖ Compte r√©activ√©', 
              message:'Votre acc√®s a √©t√© r√©tabli.', 
              details:`R√©activation par ${currentUser?.email || 'admin'}.`, 
              issuedAt: serverTimestamp(), 
              expiryDate: expiryISO, 
              issuedBy: currentUser?.email || 'admin' 
            }
          });

          await addDoc(collection(db,'admin_logs'), {
            action:'USER_UNLOCKED', 
            adminUid: currentUser?.uid || null, 
            adminEmail: currentUser?.email || null,
            targetUid: uid, 
            targetEmail: u.email || null,
            details: `Compte d√©verrouill√© + popup info (${hours}h).`, 
            timestamp: serverTimestamp()
          });

          showAlert('success', `Utilisateur ${u.email || ''} d√©verrouill√© avec succ√®s.`);

          // D√©verrouiller les vendeuses si c'est un pharmacien
          if (isPharmacien) {
            const vendeuses = allUsers.filter(v => v.role === 'vendeuse' && v.societeId === u.societeId);
            if (vendeuses.length > 0) {
              const batch = writeBatch(db);
              for (const v of vendeuses) {
                batch.update(doc(db,'users',v.uid), {
                  locked: false, 
                  lockedAt: deleteField(), 
                  lockedBy: deleteField(),
                  adminPopup: { 
                    status:'active', 
                    type:'unlockNotice', 
                    title:'‚úÖ Compte r√©activ√©', 
                    message:'Votre acc√®s a √©t√© r√©tabli par le pharmacien.', 
                    details:`Pharmacien: ${u.email || 'inconnu'}.`, 
                    issuedAt: serverTimestamp(), 
                    expiryDate: expiryISO, 
                    issuedBy: currentUser?.email || 'admin' 
                  }
                });
              }
              await batch.commit();
              
              for (const v of vendeuses) {
                await addDoc(collection(db,'admin_logs'), {
                  action:'VENDEUSE_UNLOCKED_BY_PHARMACIEN', 
                  adminUid: currentUser?.uid || null, 
                  adminEmail: currentUser?.email || null,
                  targetUid: v.uid, 
                  targetEmail: v.email || null,
                  details: `Vendeuse d√©verrouill√©e automatiquement car le pharmacien ${u.email || ''} a √©t√© r√©activ√©.`, 
                  timestamp: serverTimestamp()
                });
              }
              showAlert('info', `${vendeuses.length} vendeuse(s) de la soci√©t√© ont √©t√© d√©verrouill√©es automatiquement.`);
            }
          }
        }
      } catch (e) {
        console.error('toggleLock:', e);
        showAlert('error', `Erreur: ${e.message}`);
      }
    };

    window.togglePayment = async (uid, isPaid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');
      
      try {
        await updateDoc(doc(db, 'users', uid), {
          isPaid: !!isPaid,
          paidAt: isPaid ? serverTimestamp() : deleteField(),
          paidBy: isPaid ? currentUser?.email || 'admin' : deleteField()
        });
        
        await addDoc(collection(db, 'admin_logs'), {
          action: isPaid ? 'PAYMENT_MARKED_PAID' : 'PAYMENT_MARKED_UNPAID',
          adminUid: currentUser?.uid || null,
          adminEmail: currentUser?.email || null,
          targetUid: uid,
          targetEmail: u.email || null,
          details: `Paiement marqu√© comme ${isPaid ? 'pay√©' : 'non pay√©'}`,
          timestamp: serverTimestamp()
        });
        
        showAlert('success', `Paiement de ${u.email || 'utilisateur'} marqu√© comme ${isPaid ? 'pay√©' : 'non pay√©'}`);
      } catch (e) {
        console.error('togglePayment:', e);
        showAlert('error', `Erreur: ${e.message}`);
      }
    };

    window.togglePaymentWarning = async (uid) => {
      const u = allUsers.find(x => x.uid === uid);
      if (!u) return showAlert('error', 'Utilisateur introuvable');
      
      const isWarned = !!(u.paymentWarning && u.paymentWarning.status === 'active');
      
      try {
        if (isWarned) {
          if (!confirm(`D√©sactiver l'avertissement paiement pour ${u.email || 'cet utilisateur'} ?`)) return;
          
          await updateDoc(doc(db,'users',uid), { 
            paymentWarning: deleteField() 
          });
          
          await addDoc(collection(db,'admin_logs'), {
            action:'PAYMENT_WARNING_DISABLED', 
            adminUid: currentUser?.uid || null, 
            adminEmail: currentUser?.email || null,
            targetUid: uid, 
            targetEmail: u.email || null, 
            details:'Avertissement de paiement d√©sactiv√©.', 
            timestamp: serverTimestamp()
          });
          
          showAlert('success', `Avertissement d√©sactiv√© pour ${u.email || ''}.`);
        } else {
          const hours = parseInt(prompt("Dur√©e (heures)", "24"), 10) || 24;
          const expiryISO = new Date(Date.now() + hours * 3600 * 1000).toISOString();
          
          if (!confirm(`Envoyer AVERTISSEMENT de paiement √† ${u.email || 'cet utilisateur'} (${hours}h) ?`)) return;
          
          await updateDoc(doc(db,'users',uid), {
            paymentWarning: { 
              status:'active', 
              issuedAt: serverTimestamp(), 
              expiryDate: expiryISO, 
              issuedBy: currentUser?.email || 'admin', 
              reason:'payment' 
            }
          });
          
          await addDoc(collection(db,'admin_logs'), {
            action:'PAYMENT_WARNING_SENT', 
            adminUid: currentUser?.uid || null, 
            adminEmail: currentUser?.email || null,
            targetUid: uid, 
            targetEmail: u.email || null, 
            details:`Avertissement paiement envoy√© (${hours}h).`, 
            timestamp: serverTimestamp()
          });
          
          showAlert('success', `Avertissement envoy√© √† ${u.email || ''}.`);
        }
      } catch (e) {
        console.error('togglePaymentWarning:', e);
        showAlert('error', `Erreur: ${e.message}`);
      }
    };

    window.viewSocieteDetails = (societeId) => {
      const s = allSocietes.find(ss => ss.id === societeId);
      const users = allUsers.filter(u => u.societeId === societeId);
      
      let details = `üè¢ ${s?.name || s?.nom || societeId}\n\n`;
      details += `üìç Adresse: ${s?.address || s?.adresse || 'Non renseign√©e'}\n`;
      details += `üìû T√©l√©phone: ${s?.phone || s?.telephone || 'Non renseign√©'}\n`;
      details += `üëë Propri√©taire: ${s?.ownerEmail || 'Non renseign√©'}\n`;
      details += `üìÖ Cr√©√©e le: ${formatDate(s?.createdAt)}\n\n`;
      details += `üë• Utilisateurs (${users.length}):\n`;
      users.forEach(u => {
        details += `  ‚Ä¢ ${u.email} (${formatRole(u.role)}) ${u.active !== false ? '‚úÖ' : 'üö´'}\n`;
      });

      alert(details);
    };

    window.createInvitation = async () => {
      const email = el.inviteEmail?.value;
      const role = el.inviteRole?.value;
      const societeId = el.inviteSociete?.value;
      const note = el.inviteNote?.value;

      if (!email || !societeId) {
        return showAlert('error', 'Email et soci√©t√© sont requis');
      }

      try {
        const code = generateInvitationCode();
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + 7);

        await addDoc(collection(db, 'invitations'), {
          code,
          emailInvite: email,
          roleInvite: role,
          societeId,
          noteInvite: note,
          status: 'pending',
          createdAt: serverTimestamp(),
          createdBy: currentUser?.email || 'admin',
          expiresAt: Timestamp.fromDate(expiresAt)
        });

        await addDoc(collection(db, 'admin_logs'), {
          action: 'INVITATION_CREATED',
          adminUid: currentUser?.uid,
          adminEmail: currentUser?.email,
          targetEmail: email,
          details: `Invitation cr√©√©e par admin - Code: ${code}`,
          timestamp: serverTimestamp()
        });

        showAlert('success', `Invitation cr√©√©e ! Code: ${code}`);
        
        if (el.inviteEmail) el.inviteEmail.value = '';
        if (el.inviteNote) el.inviteNote.value = '';
      } catch (error) {
        console.error('Erreur createInvitation:', error);
        showAlert('error', `Erreur: ${error.message}`);
      }
    };

    window.cancelInvitation = async (invitationId) => {
      if (!confirm('Annuler cette invitation ?')) return;

      try {
        await updateDoc(doc(db, 'invitations', invitationId), {
          status: 'cancelled',
          cancelledAt: serverTimestamp(),
          cancelledBy: currentUser?.email || 'admin'
        });

        await addDoc(collection(db, 'admin_logs'), {
          action: 'INVITATION_CANCELLED',
          adminUid: currentUser?.uid,
          adminEmail: currentUser?.email,
          details: 'Invitation annul√©e par l\'administrateur',
          timestamp: serverTimestamp()
        });

        showAlert('success', 'Invitation annul√©e');
      } catch (error) {
        console.error('Erreur cancelInvitation:', error);
        showAlert('error', `Erreur: ${error.message}`);
      }
    };

    window.renewInvitation = async (invitationId) => {
      if (!confirm('Renouveler cette invitation avec un nouveau code ?')) return;

      try {
        const newCode = generateInvitationCode();
        const newExpiresAt = new Date();
        newExpiresAt.setDate(newExpiresAt.getDate() + 7);

        await updateDoc(doc(db, 'invitations', invitationId), {
          code: newCode,
          status: 'pending',
          expiresAt: Timestamp.fromDate(newExpiresAt),
          renewedAt: serverTimestamp(),
          renewedBy: currentUser?.email || 'admin'
        });

        showAlert('success', `Invitation renouvel√©e ! Nouveau code: ${newCode}`);
      } catch (error) {
        console.error('Erreur renewInvitation:', error);
        showAlert('error', `Erreur: ${error.message}`);
      }
    };

    window.deleteInvitation = async (invitationId) => {
      if (!confirm('Supprimer d√©finitivement cette invitation ?')) return;

      try {
        await updateDoc(doc(db, 'invitations', invitationId), {
          deleted: true,
          deletedAt: serverTimestamp(),
          deletedBy: currentUser?.email || 'admin'
        });

        showAlert('success', 'Invitation supprim√©e');
      } catch (error) {
        console.error('Erreur deleteInvitation:', error);
        showAlert('error', `Erreur: ${error.message}`);
      }
    };

    // AUTHENTIFICATION ET UI
    const updateUI = (user) => {
      if (user) {
        currentUser = user;
        isAdmin = user.email === ADMIN_EMAIL;
        el.loginForm.classList.add('hidden');
        el.userInfo.classList.remove('hidden');
        el.userEmail.textContent = user.email || '';
        el.userAvatar.textContent = (user.email || 'A').substring(0,2).toUpperCase();

        if (isAdmin) {
          el.adminInterface.classList.remove('hidden');
          el.loginPrompt.classList.add('hidden');
          listenUsers();
          listenSocietes();
          listenInvitations();
          listenLogs();
        } else {
          el.adminInterface.classList.add('hidden');
          el.loginPrompt.classList.remove('hidden');
          showAlert('warning', 'Acc√®s limit√© : vous n\'√™tes pas administrateur');
        }
      } else {
        currentUser = null;
        isAdmin = false;
        el.loginForm.classList.remove('hidden');
        el.userInfo.classList.add('hidden');
        el.adminInterface.classList.add('hidden');
        el.loginPrompt.classList.remove('hidden');
        
        if (unsubUsers) unsubUsers();
        if (unsubSocietes) unsubSocietes();
        if (unsubInvitations) unsubInvitations();
        if (unsubLogs) unsubLogs();
      }
    };

    // EVENT LISTENERS
    el.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      el.loginBtn.disabled = true;
      el.loginBtn.textContent = 'Connexion...';
      
      try {
        await signInWithEmailAndPassword(auth, el.email.value, el.password.value);
        showAlert('success', 'Connexion r√©ussie !');
      } catch (err) {
        console.error('Erreur connexion:', err);
        showAlert('error', `Erreur de connexion: ${err.message}`);
      } finally {
        el.loginBtn.disabled = false;
        el.loginBtn.textContent = 'Connexion';
      }
    });

    el.logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showAlert('info', 'D√©connexion r√©ussie');
      } catch (err) {
        showAlert('error', `Erreur d√©connexion: ${err.message}`);
      }
    });

    if (el.searchUsers) el.searchUsers.addEventListener('input', renderUsers);
    if (el.roleFilter) el.roleFilter.addEventListener('change', renderUsers);
    if (el.companyFilter) el.companyFilter.addEventListener('change', renderUsers);
    if (el.statusFilter) el.statusFilter.addEventListener('change', renderUsers);
    
    if (el.searchSocietes) el.searchSocietes.addEventListener('input', renderSocietes);
    
    if (el.searchInvitations) el.searchInvitations.addEventListener('input', renderInvitations);
    if (el.invitationStatusFilter) el.invitationStatusFilter.addEventListener('change', renderInvitations);
    
    if (el.logsSearch) el.logsSearch.addEventListener('input', renderLogs);
    if (el.logsActionFilter) el.logsActionFilter.addEventListener('change', renderLogs);

    const refreshUsersBtn = document.getElementById('refreshUsers');
    if (refreshUsersBtn) {
      refreshUsersBtn.addEventListener('click', () => {
        listenUsers();
        showAlert('info', 'Utilisateurs actualis√©s');
      });
    }
    
    const refreshSocietesBtn = document.getElementById('refreshSocietes');
    if (refreshSocietesBtn) {
      refreshSocietesBtn.addEventListener('click', () => {
        listenSocietes();
        showAlert('info', 'Soci√©t√©s actualis√©es');
      });
    }
    
    const refreshInvitationsBtn = document.getElementById('refreshInvitations');
    if (refreshInvitationsBtn) {
      refreshInvitationsBtn.addEventListener('click', () => {
        listenInvitations();
        showAlert('info', 'Invitations actualis√©es');
      });
    }
    
    const refreshLogsBtn = document.getElementById('refreshLogs');
    if (refreshLogsBtn) {
      refreshLogsBtn.addEventListener('click', () => {
        listenLogs();
        showAlert('info', 'Activit√©s actualis√©es');
      });
    }

    if (el.createInvitation) {
      el.createInvitation.addEventListener('click', () => {
        window.createInvitation();
      });
    }

    onAuthStateChanged(auth, updateUI);

    window.addEventListener('error', (e) => {
      console.error('Erreur globale:', e.error);
      showAlert('error', 'Une erreur inattendue s\'est produite');
    });

    console.log('üè¢ Administration SaaS Anapharmo Multi-tenant initialis√©e');
  </script>
</body>
</html>
